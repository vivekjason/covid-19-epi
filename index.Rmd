---
title: "COVID-19 Epidemiology for Malaysia"
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    css: styles.css
    social: menu
    vertical_layout: fill
    includes:
       in_header: GA_Script.html
---


```{r setup, include=FALSE}
library(flexdashboard)
library(EpiEstim)
library(R0)
library(tidyverse)
library(readxl)
library(readr)
library(lubridate)
library(httr)
library(zoo)
library(cowplot)
library(viridis)
library(RColorBrewer)
library(plotly)
library(todor)
library(knitr)
library(heatmaply)
library(RcppRoll)
library(gplots)
```


```{r,include=FALSE}
#wrangle the data
###########################################################################################################################################  
############################################data manipulation##############################################################################  
###########################################################################################################################################  
#clear the global environment first and clear the cache
#unlink('index_cache', recursive = TRUE)
#rm(list=ls())
#pull data set of clusters
clusters <- read_csv("P:/COVID-19/R0 Malaysia/data/cluster data/clusters_dashboard.csv", 
    col_types = cols(no = col_number(), bangau = col_number(), 
        benteng = col_number(), benteng_pk = col_number(), 
        date = col_date(format = "%d/%m/%Y"), 
        dti = col_number(), import = col_number(), 
        kepayan = col_number(), laut = col_number(), 
        meru = col_number(), penjara_jawi = col_number(), 
        penjara_reman = col_number(), penjara_sandakan = col_number(), 
        penjara_tapah = col_number(), pts_tawau = col_number(), 
        pulau = col_number(), rumah_merah = col_number(), 
        sivagangga = col_number(), sungai = col_number(), 
        tabligh = col_number(), tawar = col_number(), 
        tembok = col_number(), gk_tawau=col_number(), matambai=col_number(), 
        jalan_harapan=col_number(), bakti=col_number(), tembok_gajah=col_number(), 
        kolam_air=col_number(), hala_mutiara=col_number(), pompod=col_number(),
        pagar_siput=col_number(), pagar_bentong=col_number(), tembok_mempaga=col_number(),
        telok_mas=col_number(), tropika=col_number(), tembok_kemus=col_number(), 
        tembok_nenas=col_number(), teratai=col_number(),sungai_jelok=col_number(),
        tembok_renggam=col_number(), tembok_sgudang=col_number(), tembok_taiping=col_number(),
        bukit_besi=col_number(), pengkalan_chepa=col_number(), tembok_bendera=col_number(),
        jln_awang=col_number(), dti_persiaran_wawasan=col_number(), dti_machap_umboo=col_number(),
        tembok_muhasabah=col_number(), imigresen_semuja=col_number(), dti_juru=col_number(),
        dti_jln_duta=col_number(), bukit_chagar=col_number(), sri_aman=col_number(), 
        padang_hijau=col_number(), choh2=col_number(), jln_salleh=col_number(),
        dti_lenggeng=col_number(), dti_sandakan=col_number(), pagar_siput2=col_number(),
        sri_lalang=col_number(), kg_selamat=col_number(), pagar_rimba=col_number(),
        meru_utama=col_number()))


#pull new data set
df <- read_csv("P:/COVID-19/R0 Malaysia/data/incidence/covid-19_my.csv", 
      col_types = cols(date = col_date(format = "%d/%m/%Y"), 
        new_cases = col_number(), new_deaths = col_number(), 
        total_cases = col_number(), total_deaths = col_number(), 
        recover = col_number(), total_recover = col_number(), 
        icu = col_number(), support = col_number()))

#lock down one set#NO MANIPULATION#
core_set <- df

#cut out the dates to join with cluster
new <- df[21:as.numeric(Sys.Date()-18260),c(1,3,4,7)] # TODO: if elapsed by a day +1 to the constant (contstant=18260) (+1 for each elapsed day)
new$no <- seq(1:as.numeric(Sys.Date()-18280)) # TODO: if elapsed by a day +1 to the constant (contstant=18280)  (+1 for each elapsed day)
new$date <- as.Date(new$date)

#merge the two sets
df <- full_join(new, clusters, by=c("no","date"))

#create a special variable for all immigration and prison outbreaks
df$ins <- df$dti+df$tembok+df$benteng_pk+df$penjara_reman+df$penjara_jawi+df$kepayan+df$penjara_tapah+
  df$rumah_merah+df$pts_tawau+df$penjara_sandakan+df$gk_tawau+df$matambai+df$jalan_harapan+df$bakti+df$sibuga+
  df$tembok_gajah + df$kolam_air + df$hala_mutiara + df$pompod + df$pagar_siput + df$pagar_bentong + 
  df$tembok_mempaga + df$telok_mas +df$tropika + df$tembok_kemus + df$tembok_nenas +df$sungai_jelok +df$tembok_renggam +
  df$tembok_sgudang +  df$tembok_taiping + df$bukit_besi + df$pengkalan_chepa + df$tembok_bendera +df$jln_awang + 
  df$dti_persiaran_wawasan + df$dti_machap_umboo + df$tembok_muhasabah +df$imigresen_semuja + df$dti_juru + 
  df$ dti_jln_duta + df$bukit_chagar +df$sri_aman + df$padang_hijau + df$choh2 + df$jln_salleh + df$dti_lenggeng +
  df$dti_sandakan + df$pagar_siput2 + df$sri_lalang + df$kg_selamat + df$pagar_rimba + df$meru_utama

##########################################################################################
#arbitrary cut of point for visualisation of clusters with at least 150 cases or more
##########################################################################################
#join the 2 sets
df$daily <- df$new_cases-df$ins-df$import#benteng ld has begun in an institution but quickly spiralled into community as well

###########################################################################################################################################  
############################################estimate the rt using cori et al method#########################################################  
###########################################################################################################################################  
# sub plot a - policy and events across outbreak
#create control parameters for MCMC
res_parametric_si <- estimate_R(df$daily, 
                                method="parametric_si",
                                config = make_config(list(
                                  mean_si = 5.12, #lit review
                                  std_si = 1.86))#lit review
)

###########################################################################################################################################  
############################################PLAY AROUND WITH the SI####################################################################### 
###########################################################################################################################################
#THE SI DISTRIBUTION- LINK TO si_intervals.rmd
#including the walinga teunis and riberio estimations
#####REVISIT THIS####
###########NEED TO REALLY THINK OF A WAY TO ESTIMATE THE SI INTERVAL#############
######################################################################################

###########################################################################################################################################  
############################################POSTPROCESSING#################################################################################  
###########################################################################################################################################

#extract information from the set
x <- as.data.frame(res_parametric_si$R)
mas_r0_df<- as.data.frame(x$R[,c(1:3,5,11)])

#fill up blanks
t <- seq(1:7)
time <- c(t,x$t_end)
n <- c(NA,NA,NA,NA,NA,NA,NA)
r0 <- c(n,x$`Mean(R)`)
lower <- c(n,x$`Quantile.0.025(R)`)
upper <- c(n,x$`Quantile.0.975(R)`)

#create new data frame
df$date <- as.Date(df$date)
ts_mas <- as.data.frame(cbind(df$new_cases,df$recover, df$new_deaths, 
                              df$daily,df$tabligh,df$ins,df$import,df$benteng,df$bangau,time,r0,lower,upper))
ts_mas$date <- as.Date(df$date)
colnames(ts_mas) <- c('new',"discharged","death","daily","tabligh","ins","import","fotress","bangau","day","r0","lower","upper","date")
ts_mas$tabligh[is.na(ts_mas$tabligh)] <- 0

#create a new dataset
new <- df[,c(1:2)]
new <- as.data.frame(new)

#create moving averages
new <- new %>%
  mutate(daily_ma01 = rollmean(new_cases, k = 7, fill = "extend"))

#back convert dates
new$date <- as.Date(new$date)

#add moving average to df
ts_mas$daily_ma1 <- new$daily_ma01

#create a daily that doesnt include the rest
ts_mas$d <- ts_mas$new-ts_mas$tabligh-ts_mas$ins-ts_mas$import-ts_mas$fotress-ts_mas$bangau

#add on icu and ventilator cases
ts_mas$icu <- core_set$icu[21:nrow(core_set)] 
ts_mas$ventilator <- core_set$support[21:nrow(core_set)] 

##define key paremeters of amalysian population
mas_pop <- 32730000
mas_bed <- 3825+12235 +4394 +1000 + 4002 #last updated on 25 December 2020
mas_icu <- 871
mas_ven <- 1581

#get total cases, deaths and discharges
ts_mas$cumsum <- cumsum(ts_mas$new)
ts_mas$cumsum_death <- cumsum(ts_mas$death)
ts_mas$cumsum_discharged <- cumsum(ts_mas$discharged)

#create a 14-day moving incidence rate
ts_mas$incident14 <- rollsum(ts_mas$new,k=14,fill=NA, align="right")

#calculate the incidence 
ts_mas$incidence<- round((ts_mas$cumsum/mas_pop)*100000,2)
ts_mas$incidence14_rate <- round((ts_mas$incident14/mas_pop)*100000,2)
#add active cases
ts_mas$active <- ts_mas$cumsum-ts_mas$cumsum_discharged-ts_mas$cumsum_death

#add bed percentage annd icu percentage
ts_mas$bed_perc5 <- (ts_mas$active/mas_bed)*100
ts_mas$bed_perc5[ts_mas$bed_perc5<0] <- 0
ts_mas$icu_perc <- (ts_mas$icu/mas_icu)*100
ts_mas$icu_perc[ts_mas$icu_perc<0] <- 0
ts_mas$ven_perc <- (ts_mas$ventilator/mas_ven)*100
ts_mas$ven_perc [ts_mas$ven_perc <0] <- 0

#add a column to merge by
ts_mas$state <- "Malaysia"

################################################################################################################################
############################################pivot and plot######################################################################
################################################################################################################################
ts <- ts_mas%>% dplyr::select(date, d,import, tabligh, ins, fotress, bangau) %>% pivot_longer(names_to="type",values_to = "cases", -"date")

#shorten the confidence bands
ts_mas_short <- ts_mas
ts_mas_short$upper[ts_mas_short$upper>27.5] <- 27.0
ts_mas_short$lower[ts_mas_short$lower<0] <- 0.01

################################################################################################################################
############################################mobility reports######################################################################
################################################################################################################################
#import the mobility data and get them into states
#download link
#https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv

#load data
Global_Mobility_Report_3_ <- read_csv("P:/COVID-19/R0 Malaysia/data/mobility/Global_Mobility_Report_210507.csv", 
                                      col_types = cols(census_fips_code = col_character(), 
                                                       date = col_character(), grocery_and_pharmacy_percent_change_from_baseline = col_number(), 
                                                       iso_3166_2_code = col_character(), 
                                                       parks_percent_change_from_baseline = col_number(), 
                                                       residential_percent_change_from_baseline = col_number(), 
                                                       retail_and_recreation_percent_change_from_baseline = col_number(), 
                                                       sub_region_1 = col_character(), sub_region_2 = col_character(), 
                                                       transit_stations_percent_change_from_baseline = col_number(), 
                                                       workplaces_percent_change_from_baseline = col_number()))
# FIXME: update this daily 

#add an avergae mobility to the ts_mas dataset
malaysia_mobility <- Global_Mobility_Report_3_%>% filter(country_region=="Malaysia" & is.na(sub_region_1))
malaysia_mobility <- malaysia_mobility[,c(2,8:14)]
malaysia_mobility$date <- as.Date(malaysia_mobility$date)
ts_mas <- full_join(ts_mas, malaysia_mobility, by="date")
ts_mas$average <- (ts_mas$parks_percent_change_from_baseline + ts_mas$grocery_and_pharmacy_percent_change_from_baseline +
                      ts_mas$retail_and_recreation_percent_change_from_baseline)/3

#chnge the names to shorter ones
names(ts_mas)[names(ts_mas)=="retail_and_recreation_percent_change_from_baseline"]="recreation"
names(ts_mas)[names(ts_mas)=="grocery_and_pharmacy_percent_change_from_baseline"]="grocery"
names(ts_mas)[names(ts_mas)=="parks_percent_change_from_baseline"]="parks"
names(ts_mas)[names(ts_mas)=="transit_stations_percent_change_from_baseline"]="transit"
names(ts_mas)[names(ts_mas)=="workplaces_percent_change_from_baseline"]="work"
names(ts_mas)[names(ts_mas)=="residential_percent_change_from_baseline"]="residence"

```



```{r, include=FALSE}
#get the data for states in
#load Malaysian data by state from data.world
df <- read_csv("P:/COVID-19/R0 Malaysia/data/incidence/covid-19_my_state_v2.csv", 
        col_types = cols(date = col_date(format = "%d/%m/%Y"), 
        new_cases = col_number(), total_cases = col_number(), 
        new_deaths = col_number(), total_deaths = col_number()))
state <- df

#repeat total cases for first 2 days
state$new_cases[c(1:16)] <- state$total_cases[c(1:16)]

#remove NA's
state[is.na(state)] <- 0
state$date <- as.Date(state$date)

#change selected state spelling
state$state[state$state=="PERLIS"] <- 'Perlis'
state$state[state$state=="KEDAH"] <- 'Kedah'
state$state[state$state=="PULAU PINANG"] <- 'Pulau Pinang'
state$state[state$state=="PERAK"] <- 'Perak'
state$state[state$state=="SELANGOR"] <- 'Selangor'
state$state[state$state=="NEGERI SEMBILAN"] <- 'Negeri Sembilan'
state$state[state$state=="MELAKA"] <- 'Melaka'
state$state[state$state=="JOHOR"] <- 'Johor'
state$state[state$state=="PAHANG"] <- 'Pahang'
state$state[state$state=="TERENGGANU"] <- "Terengganu"
state$state[state$state=="KELANTAN"] <- 'Kelantan'
state$state[state$state=="SABAH"] <- 'Sabah'
state$state[state$state=="SARAWAK"] <- 'Sarawak'
state$state[state$state=="WP LABUAN"] <- 'W.P. Labuan'
state$state[state$state=="WP KUALA LUMPUR"] <- "W.P. Kuala Lumpur"
state$state[state$state=="WP PUTRAJAYA"] <- 'W.P. Putrajaya'

#clean up data
mobility <- Global_Mobility_Report_3_
mobility$sub_region_1[is.na(mobility$sub_region_1)] <- "country_level"
mobility <- mobility %>% filter(country_region=="Malaysia", sub_region_1!="country_level")
mobility$date <- as.Date(mobility$date)
mobility <- mobility[,-c(1,4,5,6,7,8)]
colnames(mobility) <- c("country","state","date","recreation","grocery", "parks","transit","work","residence")

#statndardise the states
mobility$state[mobility$state=="Penang"] <- 'Pulau Pinang'
mobility$state[mobility$state=="Malacca"] <- 'Melaka'
mobility$state[mobility$state=="Terengganu"] <- "Terengganu"
mobility$state[mobility$state=="Labuan Federal Territory"] <- 'W.P. Labuan'
mobility$state[mobility$state=="Federal Territory of Kuala Lumpur"] <- "W.P. Kuala Lumpur"
mobility$state[mobility$state=="Putrajaya"] <- 'W.P. Putrajaya'

#convert mobility into a dataframe
mobility <- as.data.frame(mobility)

#######################################################################################################
#filter: perlis
perlis <- state %>% filter(state=="Perlis")

#create control parameters for MCMC
perlis_r0 <- estimate_R(perlis$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(perlis_r0)
perlis_r0_df<- as.data.frame(perlis_r0$R[,c(1:3,5,11)])
perlis_r0_df$date <- seq(from=as.Date("2020-03-20"),to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
perlis_r0_df <- perlis_r0_df[,3:6]
perlis_r0_df$state <- "Perlis"
colnames(perlis_r0_df) <- c("rt","lower","upper","date","state")
perlis_r0_df$case <- perlis$new_cases[8:nrow(perlis)]
perlis_r0_df$total_case <- perlis$total_cases[8:nrow(perlis)]
perlis_r0_df$new_death <- perlis$new_deaths[8:nrow(perlis)]

perlis_r0_df$active_cases_part3[4:nrow(perlis_r0_df)] <- diff(perlis_r0_df$total_case, lag=3)
perlis_r0_df$active_cases3 <- perlis_r0_df$active_cases_part3-perlis_r0_df$new_death
perlis_r0_df$active_cases3[1:3] <- cumsum(perlis_r0_df$case[1:3])-perlis_r0_df$new_death[1:3]
perlis_r0_df$active_cases3[perlis_r0_df$active_cases3<=0] <- 0

perlis_r0_df$active_cases_part5[6:nrow(perlis_r0_df)] <- diff(perlis_r0_df$total_case, lag=5)
perlis_r0_df$active_cases5 <- perlis_r0_df$active_cases_part5-perlis_r0_df$new_death
perlis_r0_df$active_cases5[1:5] <- cumsum(perlis_r0_df$case[1:5])-perlis_r0_df$new_death[1:5]
perlis_r0_df$active_cases5[perlis_r0_df$active_cases5<=0] <- 0

perlis_r0_df$active_cases_part9[10:nrow(perlis_r0_df)] <- diff(perlis_r0_df$total_case, lag=9)
perlis_r0_df$active_cases9 <- perlis_r0_df$active_cases_part9-perlis_r0_df$new_death
perlis_r0_df$active_cases9[1:9] <- cumsum(perlis_r0_df$case[1:9])-perlis_r0_df$new_death[1:9]
perlis_r0_df$active_cases9[perlis_r0_df$active_cases9<=0] <- 0

perlis_r0_df <- perlis_r0_df[1:nrow(perlis_r0_df),]
perlis_r0_df

#create moving averages
perlis_r0_df <- perlis_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
perlis_r0_df$incident14 <- rollsum(perlis_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_perlis <- mobility %>% filter (state=="Perlis" & date >as.Date("2020-03-19")) 

#create a new varaible for state
perlis<- full_join(perlis_r0_df, mobility_perlis, by=c("date","state"))

#add ab average
perlis$average <- (perlis$recreation+perlis$grocery+perlis$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: kedah
kedah <- state %>% filter(state=="Kedah")

#create control parameters for MCMC
kedah_r0 <- estimate_R(kedah$new_cases, 
                       method="parametric_si",
                       config = make_config(list(
                         mean_si = 5.12, 
                         std_si = 1.86))#lit review
)

#create df of parameters
plot(kedah_r0)
kedah_r0_df<- as.data.frame(kedah_r0$R[,c(1:3,5,11)])
kedah_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
kedah_r0_df <- kedah_r0_df[,3:6]
kedah_r0_df$state <- "Kedah"
colnames(kedah_r0_df) <- c("rt","lower","upper","date","state")
kedah_r0_df$case <- kedah$new_cases[8:nrow(kedah)]
kedah_r0_df$total_case <- kedah$total_cases[8:nrow(kedah)]
kedah_r0_df$new_death <- kedah$new_deaths[8:nrow(kedah)]

kedah_r0_df$active_cases_part3[4:nrow(kedah_r0_df)] <- diff(kedah_r0_df$total_case, lag=3)
kedah_r0_df$active_cases3 <- kedah_r0_df$active_cases_part3-kedah_r0_df$new_death
kedah_r0_df$active_cases3[1:3] <- cumsum(kedah_r0_df$case[1:3])-kedah_r0_df$new_death[1:3]
kedah_r0_df$active_cases3[kedah_r0_df$active_cases3<=0] <- 0

kedah_r0_df$active_cases_part5[6:nrow(kedah_r0_df)] <- diff(kedah_r0_df$total_case, lag=5)
kedah_r0_df$active_cases5 <- kedah_r0_df$active_cases_part5-kedah_r0_df$new_death
kedah_r0_df$active_cases5[1:5] <- cumsum(kedah_r0_df$case[1:5])-kedah_r0_df$new_death[1:5]
kedah_r0_df$active_cases5[kedah_r0_df$active_cases5<=0] <- 0

kedah_r0_df$active_cases_part9[10:nrow(kedah_r0_df)] <- diff(kedah_r0_df$total_case, lag=9)
kedah_r0_df$active_cases9 <- kedah_r0_df$active_cases_part9-kedah_r0_df$new_death
kedah_r0_df$active_cases9[1:9] <- cumsum(kedah_r0_df$case[1:9])-kedah_r0_df$new_death[1:9]
kedah_r0_df$active_cases9[kedah_r0_df$active_cases9<=0] <- 0

kedah_r0_df <- kedah_r0_df[1:nrow(kedah_r0_df),]
kedah_r0_df

#create moving averages
kedah_r0_df <- kedah_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
kedah_r0_df$incident14 <- rollsum(kedah_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_kedah <- mobility %>% filter (state=="Kedah" & date >as.Date("2020-03-19")) 

#create a new varaible for state
kedah<- full_join(kedah_r0_df, mobility_kedah, by=c("date","state"))

#add ab average
kedah$average <- (kedah$recreation+kedah$grocery+kedah$parks)/3

#################################################################################################################################
#################################################################################################################################
#filter: penang
penang <- state %>% filter(state=="Pulau Pinang")

#create control parameters for MCMC
penang_r0 <- estimate_R(penang$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(penang_r0)
penang_r0_df<- as.data.frame(penang_r0$R[,c(1:3,5,11)])
penang_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
penang_r0_df <- penang_r0_df[,3:6]
penang_r0_df$state <- "Pulau Pinang"
colnames(penang_r0_df) <- c("rt","lower","upper","date","state")
penang_r0_df$case <- penang$new_cases[8:nrow(penang)]
penang_r0_df$total_case <- penang$total_cases[8:nrow(penang)]
penang_r0_df$new_death <- penang$new_deaths[8:nrow(penang)]

penang_r0_df$active_cases_part3[4:nrow(penang_r0_df)] <- diff(penang_r0_df$total_case, lag=3)
penang_r0_df$active_cases3 <- penang_r0_df$active_cases_part3-penang_r0_df$new_death
penang_r0_df$active_cases3[1:3] <- cumsum(penang_r0_df$case[1:3])-penang_r0_df$new_death[1:3]
penang_r0_df$active_cases3[penang_r0_df$active_cases3<=0] <- 0

penang_r0_df$active_cases_part5[6:nrow(penang_r0_df)] <- diff(penang_r0_df$total_case, lag=5)
penang_r0_df$active_cases5 <- penang_r0_df$active_cases_part5-penang_r0_df$new_death
penang_r0_df$active_cases5[1:5] <- cumsum(penang_r0_df$case[1:5])-penang_r0_df$new_death[1:5]
penang_r0_df$active_cases5[penang_r0_df$active_cases5<=0] <- 0

penang_r0_df$active_cases_part9[10:nrow(penang_r0_df)] <- diff(penang_r0_df$total_case, lag=9)
penang_r0_df$active_cases9 <- penang_r0_df$active_cases_part9-penang_r0_df$new_death
penang_r0_df$active_cases9[1:9] <- cumsum(penang_r0_df$case[1:9])-penang_r0_df$new_death[1:9]
penang_r0_df$active_cases9[penang_r0_df$active_cases9<=0] <- 0

penang_r0_df <- penang_r0_df[1:nrow(penang_r0_df),]
penang_r0_df

#create moving averages
penang_r0_df <- penang_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
penang_r0_df$incident14 <- rollsum(penang_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_penang<- mobility %>% filter (state=="Pulau Pinang" & date >as.Date("2020-03-19")) 

#create a new varaible for state
penang<- full_join(penang_r0_df, mobility_penang, by=c("date","state"))

#add ab average
penang$average <- (penang$recreation+penang$grocery+penang$parks)/3

#################################################################################################################################
#################################################################################################################################
#filter: perak
perak <- state %>% filter(state=="Perak")

#create control parameters for MCMC
perak_r0 <- estimate_R(perak$new_cases, 
                       method="parametric_si",
                       config = make_config(list(
                         mean_si = 5.12, 
                         std_si = 1.86))#lit review
)

#create df of parameters
plot(perak_r0)
perak_r0_df<- as.data.frame(perak_r0$R[,c(1:3,5,11)])
perak_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
perak_r0_df <- perak_r0_df[,3:6]
perak_r0_df$state <- "Perak"
colnames(perak_r0_df) <- c("rt","lower","upper","date","state")
perak_r0_df$case <- perak$new_cases[8:nrow(perak)]
perak_r0_df$total_case <- perak$total_cases[8:nrow(perak)]
perak_r0_df$new_death <- perak$new_deaths[8:nrow(perak)]

perak_r0_df$active_cases_part3[4:nrow(perak_r0_df)] <- diff(perak_r0_df$total_case, lag=3)
perak_r0_df$active_cases3 <- perak_r0_df$active_cases_part3-perak_r0_df$new_death
perak_r0_df$active_cases3[1:3] <- cumsum(perak_r0_df$case[1:3])-perak_r0_df$new_death[1:3]
perak_r0_df$active_cases3[perak_r0_df$active_cases3<=0] <- 0

perak_r0_df$active_cases_part5[6:nrow(perak_r0_df)] <- diff(perak_r0_df$total_case, lag=5)
perak_r0_df$active_cases5 <- perak_r0_df$active_cases_part5-perak_r0_df$new_death
perak_r0_df$active_cases5[1:5] <- cumsum(perak_r0_df$case[1:5])-perak_r0_df$new_death[1:5]
perak_r0_df$active_cases5[perak_r0_df$active_cases5<=0] <- 0

perak_r0_df$active_cases_part9[10:nrow(perak_r0_df)] <- diff(perak_r0_df$total_case, lag=9)
perak_r0_df$active_cases9 <- perak_r0_df$active_cases_part9-perak_r0_df$new_death
perak_r0_df$active_cases9[1:9] <- cumsum(perak_r0_df$case[1:9])-perak_r0_df$new_death[1:9]
perak_r0_df$active_cases9[perak_r0_df$active_cases9<=0] <- 0

perak_r0_df <- perak_r0_df[1:nrow(perak_r0_df),]
perak_r0_df

#create moving averages
perak_r0_df <- perak_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
perak_r0_df$incident14 <- rollsum(perak_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_perak<- mobility %>% filter (state=="Perak" & date >as.Date("2020-03-19")) 

#create a new varaible for state
perak<- full_join(perak_r0_df, mobility_perak, by=c("date","state"))

#add ab average
perak$average <- (perak$recreation+perak$grocery+perak$parks)/3

#################################################################################################################################
#################################################################################################################################
#filter: selangor
selangor <- state %>% filter(state=="Selangor")

#create control parameters for MCMC
selangor_r0 <- estimate_R(selangor$new_cases, 
                          method="parametric_si",
                          config = make_config(list(
                            mean_si = 5.12, 
                            std_si = 1.86))#lit review
)

#create df of parameters
plot(selangor_r0)
selangor_r0_df<- as.data.frame(selangor_r0$R[,c(1:3,5,11)])
selangor_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)  
selangor_r0_df <- selangor_r0_df[,3:6]
selangor_r0_df$state <- "Selangor"
colnames(selangor_r0_df) <- c("rt","lower","upper","date","state")
selangor_r0_df$case <- selangor$new_cases[8:nrow(selangor)]
selangor_r0_df$total_case <- selangor$total_cases[8:nrow(selangor)]
selangor_r0_df$new_death <- selangor$new_deaths[8:nrow(selangor)]

selangor_r0_df$active_cases_part3[4:nrow(selangor_r0_df)] <- diff(selangor_r0_df$total_case, lag=3)
selangor_r0_df$active_cases3 <- selangor_r0_df$active_cases_part3-selangor_r0_df$new_death
selangor_r0_df$active_cases3[1:3] <- cumsum(selangor_r0_df$case[1:3])-selangor_r0_df$new_death[1:3]
selangor_r0_df$active_cases3[selangor_r0_df$active_cases3<=0] <- 0

selangor_r0_df$active_cases_part5[6:nrow(selangor_r0_df)] <- diff(selangor_r0_df$total_case, lag=5)
selangor_r0_df$active_cases5 <- selangor_r0_df$active_cases_part5-selangor_r0_df$new_death
selangor_r0_df$active_cases5[1:5] <- cumsum(selangor_r0_df$case[1:5])-selangor_r0_df$new_death[1:5]
selangor_r0_df$active_cases5[selangor_r0_df$active_cases5<=0] <- 0

selangor_r0_df$active_cases_part9[10:nrow(selangor_r0_df)] <- diff(selangor_r0_df$total_case, lag=9)
selangor_r0_df$active_cases9 <- selangor_r0_df$active_cases_part9-selangor_r0_df$new_death
selangor_r0_df$active_cases9[1:9] <- cumsum(selangor_r0_df$case[1:9])-selangor_r0_df$new_death[1:9]
selangor_r0_df$active_cases9[selangor_r0_df$active_cases9<=0] <- 0

selangor_r0_df <- selangor_r0_df[1:nrow(selangor_r0_df),]
selangor_r0_df

#create moving averages
selangor_r0_df <- selangor_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
selangor_r0_df$incident14 <- rollsum(selangor_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_selangor<- mobility %>% filter (state=="Selangor" & date >as.Date("2020-03-19")) 

#create a new varaible for state
selangor<- full_join(selangor_r0_df, mobility_selangor, by=c("date","state"))

#add ab average
selangor$average <- (selangor$recreation+selangor$grocery+selangor$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: kl
kl <- state %>% filter(state=="W.P. Kuala Lumpur")

#create control parameters for MCMC
kl_r0 <- estimate_R(kl$new_cases, 
                    method="parametric_si",
                    config = make_config(list(
                      mean_si = 5.12, 
                      std_si = 1.86))#lit review
)

#create df of parameters
plot(kl_r0)
kl_r0_df<- as.data.frame(kl_r0$R[,c(1:3,5,11)])
kl_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
kl_r0_df <- kl_r0_df[,3:6]
kl_r0_df$state <- "W.P. Kuala Lumpur"
colnames(kl_r0_df) <- c("rt","lower","upper","date","state")
kl_r0_df$case <- kl$new_cases[8:nrow(kl)]
kl_r0_df$total_case <- kl$total_cases[8:nrow(kl)]
kl_r0_df$new_death <- kl$new_deaths[8:nrow(kl)]

kl_r0_df$active_cases_part3[4:nrow(kl_r0_df)] <- diff(kl_r0_df$total_case, lag=3)
kl_r0_df$active_cases3 <- kl_r0_df$active_cases_part3-kl_r0_df$new_death
kl_r0_df$active_cases3[1:3] <- cumsum(kl_r0_df$case[1:3])-kl_r0_df$new_death[1:3]
kl_r0_df$active_cases3[kl_r0_df$active_cases3<=0] <- 0

kl_r0_df$active_cases_part5[6:nrow(kl_r0_df)] <- diff(kl_r0_df$total_case, lag=5)
kl_r0_df$active_cases5 <- kl_r0_df$active_cases_part5-kl_r0_df$new_death
kl_r0_df$active_cases5[1:5] <- cumsum(kl_r0_df$case[1:5])-kl_r0_df$new_death[1:5]
kl_r0_df$active_cases5[kl_r0_df$active_cases5<=0] <- 0

kl_r0_df$active_cases_part9[10:nrow(kl_r0_df)] <- diff(kl_r0_df$total_case, lag=9)
kl_r0_df$active_cases9 <- kl_r0_df$active_cases_part9-kl_r0_df$new_death
kl_r0_df$active_cases9[1:9] <- cumsum(kl_r0_df$case[1:9])-kl_r0_df$new_death[1:9]
kl_r0_df$active_cases9[kl_r0_df$active_cases9<=0] <- 0

kl_r0_df <- kl_r0_df[1:nrow(kl_r0_df),]
kl_r0_df

#create moving averages
kl_r0_df <- kl_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
kl_r0_df$incident14 <- rollsum(kl_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_kl<- mobility %>% filter (state=="W.P. Kuala Lumpur" & date >as.Date("2020-03-19")) 

#create a new varaible for state
kl<- full_join(kl_r0_df, mobility_kl, by=c("date","state"))

#add ab average
kl$average <- (kl$recreation+kl$grocery+kl$parks+kl$transit+kl$work)/5
#################################################################################################################################
#################################################################################################################################
#filter: putrajaya
putrajaya <- state %>% filter(state=="W.P. Putrajaya")

#create control parameters for MCMC
putrajaya_r0 <- estimate_R(putrajaya$new_cases, 
                           method="parametric_si",
                           config = make_config(list(
                             mean_si = 5.12, 
                             std_si = 1.86))#lit review
)

#create df of parameters
plot(putrajaya_r0)
putrajaya_r0_df<- as.data.frame(putrajaya_r0$R[,c(1:3,5,11)])
putrajaya_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
putrajaya_r0_df <- putrajaya_r0_df[,3:6]
putrajaya_r0_df$state <- "W.P. Putrajaya"
colnames(putrajaya_r0_df) <- c("rt","lower","upper","date","state")
putrajaya_r0_df$case <- putrajaya$new_cases[8:nrow(putrajaya)]
putrajaya_r0_df$total_case <- putrajaya$total_cases[8:nrow(putrajaya)]
putrajaya_r0_df$new_death <- putrajaya$new_deaths[8:nrow(putrajaya)]

putrajaya_r0_df$active_cases_part3[4:nrow(putrajaya_r0_df)] <- diff(putrajaya_r0_df$total_case, lag=3)
putrajaya_r0_df$active_cases3 <- putrajaya_r0_df$active_cases_part3-putrajaya_r0_df$new_death
putrajaya_r0_df$active_cases3[1:3] <- cumsum(putrajaya_r0_df$case[1:3])-putrajaya_r0_df$new_death[1:3]
putrajaya_r0_df$active_cases3[putrajaya_r0_df$active_cases3<=0] <- 0

putrajaya_r0_df$active_cases_part5[6:nrow(putrajaya_r0_df)] <- diff(putrajaya_r0_df$total_case, lag=5)
putrajaya_r0_df$active_cases5 <- putrajaya_r0_df$active_cases_part5-putrajaya_r0_df$new_death
putrajaya_r0_df$active_cases5[1:5] <- cumsum(putrajaya_r0_df$case[1:5])-putrajaya_r0_df$new_death[1:5]
putrajaya_r0_df$active_cases5[putrajaya_r0_df$active_cases5<=0] <- 0

putrajaya_r0_df$active_cases_part9[10:nrow(putrajaya_r0_df)] <- diff(putrajaya_r0_df$total_case, lag=9)
putrajaya_r0_df$active_cases9 <- putrajaya_r0_df$active_cases_part9-putrajaya_r0_df$new_death
putrajaya_r0_df$active_cases9[1:9] <- cumsum(putrajaya_r0_df$case[1:9])-putrajaya_r0_df$new_death[1:9]
putrajaya_r0_df$active_cases9[putrajaya_r0_df$active_cases9<=0] <- 0

putrajaya_r0_df <- putrajaya_r0_df[1:nrow(putrajaya_r0_df),]
putrajaya_r0_df

#create moving averages
putrajaya_r0_df <- putrajaya_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
putrajaya_r0_df$incident14 <- rollsum(putrajaya_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_putrajaya<- mobility %>% filter (state=="W.P. Putrajaya" & date >as.Date("2020-03-19")) 

#create a new varaible for state
putrajaya<- full_join(putrajaya_r0_df, mobility_putrajaya, by=c("date","state"))

#add ab average
putrajaya$average <- (putrajaya$recreation+putrajaya$grocery+putrajaya$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: negeri
negeri<- state %>% filter(state=="Negeri Sembilan")

#create control parameters for MCMC
negeri_r0 <- estimate_R(negeri$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(negeri_r0)
negeri_r0_df<- as.data.frame(negeri_r0$R[,c(1:3,5,11)])
negeri_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
negeri_r0_df <- negeri_r0_df[,3:6]
negeri_r0_df$state <- "Negeri Sembilan"
colnames(negeri_r0_df) <- c("rt","lower","upper","date","state")
negeri_r0_df$case <- negeri$new_cases[8:nrow(negeri)]
negeri_r0_df$total_case <- negeri$total_cases[8:nrow(negeri)]
negeri_r0_df$new_death <- negeri$new_deaths[8:nrow(negeri)]

negeri_r0_df$active_cases_part3[4:nrow(negeri_r0_df)] <- diff(negeri_r0_df$total_case, lag=3)
negeri_r0_df$active_cases3 <- negeri_r0_df$active_cases_part3-negeri_r0_df$new_death
negeri_r0_df$active_cases3[1:3] <- cumsum(negeri_r0_df$case[1:3])-negeri_r0_df$new_death[1:3]
negeri_r0_df$active_cases3[negeri_r0_df$active_cases3<=0] <- 0

negeri_r0_df$active_cases_part5[6:nrow(negeri_r0_df)] <- diff(negeri_r0_df$total_case, lag=5)
negeri_r0_df$active_cases5 <- negeri_r0_df$active_cases_part5-negeri_r0_df$new_death
negeri_r0_df$active_cases5[1:5] <- cumsum(negeri_r0_df$case[1:5])-negeri_r0_df$new_death[1:5]
negeri_r0_df$active_cases5[negeri_r0_df$active_cases5<=0] <- 0

negeri_r0_df$active_cases_part9[10:nrow(negeri_r0_df)] <- diff(negeri_r0_df$total_case, lag=9)
negeri_r0_df$active_cases9 <- negeri_r0_df$active_cases_part9-negeri_r0_df$new_death
negeri_r0_df$active_cases9[1:9] <- cumsum(negeri_r0_df$case[1:9])-negeri_r0_df$new_death[1:9]
negeri_r0_df$active_cases9[negeri_r0_df$active_cases9<=0] <- 0

negeri_r0_df <- negeri_r0_df[1:nrow(negeri_r0_df),]
negeri_r0_df

#create moving averages
negeri_r0_df <- negeri_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
negeri_r0_df$incident14 <- rollsum(negeri_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_negeri<- mobility %>% filter (state=="Negeri Sembilan" & date >as.Date("2020-03-19")) 

#create a new varaible for state
negeri<- full_join(negeri_r0_df, mobility_negeri, by=c("date","state"))

#add ab average
negeri$average <- (negeri$recreation+negeri$grocery+negeri$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: melaka
melaka<- state %>% filter(state=="Melaka")

#create control parameters for MCMC
melaka_r0 <- estimate_R(melaka$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(melaka_r0)
melaka_r0_df<- as.data.frame(melaka_r0$R[,c(1:3,5,11)])
melaka_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
melaka_r0_df <- melaka_r0_df[,3:6]
melaka_r0_df$state <- "Melaka"
colnames(melaka_r0_df) <- c("rt","lower","upper","date","state")
melaka_r0_df$case <- melaka$new_cases[8:nrow(melaka)]
melaka_r0_df$total_case <- melaka$total_cases[8:nrow(melaka)]
melaka_r0_df$new_death <- melaka$new_deaths[8:nrow(melaka)]

melaka_r0_df$active_cases_part3[4:nrow(melaka_r0_df)] <- diff(melaka_r0_df$total_case, lag=3)
melaka_r0_df$active_cases3 <- melaka_r0_df$active_cases_part3-melaka_r0_df$new_death
melaka_r0_df$active_cases3[1:3] <- cumsum(melaka_r0_df$case[1:3])-melaka_r0_df$new_death[1:3]
melaka_r0_df$active_cases3[melaka_r0_df$active_cases3<=0] <- 0

melaka_r0_df$active_cases_part5[6:nrow(melaka_r0_df)] <- diff(melaka_r0_df$total_case, lag=5)
melaka_r0_df$active_cases5 <- melaka_r0_df$active_cases_part5-melaka_r0_df$new_death
melaka_r0_df$active_cases5[1:5] <- cumsum(melaka_r0_df$case[1:5])-melaka_r0_df$new_death[1:5]
melaka_r0_df$active_cases5[melaka_r0_df$active_cases5<=0] <- 0

melaka_r0_df$active_cases_part9[10:nrow(melaka_r0_df)] <- diff(melaka_r0_df$total_case, lag=9)
melaka_r0_df$active_cases9 <- melaka_r0_df$active_cases_part9-melaka_r0_df$new_death
melaka_r0_df$active_cases9[1:9] <- cumsum(melaka_r0_df$case[1:9])-melaka_r0_df$new_death[1:9]
melaka_r0_df$active_cases9[melaka_r0_df$active_cases9<=0] <- 0

melaka_r0_df <- melaka_r0_df[1:nrow(melaka_r0_df),]
melaka_r0_df

#create moving averages
melaka_r0_df <- melaka_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
melaka_r0_df$incident14 <- rollsum(melaka_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_melaka<- mobility %>% filter (state=="Melaka" & date >as.Date("2020-03-19")) 

#create a new varaible for state
melaka<- full_join(melaka_r0_df, mobility_melaka, by=c("date","state"))

#add ab average
melaka$average <- (melaka$recreation+melaka$grocery+melaka$park)/3

#################################################################################################################################
#################################################################################################################################
#filter: johor
johor<- state %>% filter(state=="Johor")

#create control parameters for MCMC
johor_r0 <- estimate_R(johor$new_cases, 
                       method="parametric_si",
                       config = make_config(list(
                         mean_si = 5.12, 
                         std_si = 1.86))#lit review
)

#create df of parameters
plot(johor_r0)
johor_r0_df<- as.data.frame(johor_r0$R[,c(1:3,5,11)])
johor_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day) 
johor_r0_df <- johor_r0_df[,3:6]
johor_r0_df$state <- "Johor"
colnames(johor_r0_df) <- c("rt","lower","upper","date","state")
johor_r0_df$case <- johor$new_cases[8:nrow(johor)]
johor_r0_df$total_case <- johor$total_cases[8:nrow(johor)]
johor_r0_df$new_death <- johor$new_deaths[8:nrow(johor)]

johor_r0_df$active_cases_part3[4:nrow(johor_r0_df)] <- diff(johor_r0_df$total_case, lag=3)
johor_r0_df$active_cases3 <- johor_r0_df$active_cases_part3-johor_r0_df$new_death
johor_r0_df$active_cases3[1:3] <- cumsum(johor_r0_df$case[1:3])-johor_r0_df$new_death[1:3]
johor_r0_df$active_cases3[johor_r0_df$active_cases3<=0] <- 0

johor_r0_df$active_cases_part5[6:nrow(johor_r0_df)] <- diff(johor_r0_df$total_case, lag=5)
johor_r0_df$active_cases5 <- johor_r0_df$active_cases_part5-johor_r0_df$new_death
johor_r0_df$active_cases5[1:5] <- cumsum(johor_r0_df$case[1:5])-johor_r0_df$new_death[1:5]
johor_r0_df$active_cases5[johor_r0_df$active_cases5<=0] <- 0

johor_r0_df$active_cases_part9[10:nrow(johor_r0_df)] <- diff(johor_r0_df$total_case, lag=9)
johor_r0_df$active_cases9 <- johor_r0_df$active_cases_part9-johor_r0_df$new_death
johor_r0_df$active_cases9[1:9] <- cumsum(johor_r0_df$case[1:9])-johor_r0_df$new_death[1:9]
johor_r0_df$active_cases9[johor_r0_df$active_cases9<=0] <- 0

johor_r0_df <- johor_r0_df[1:nrow(johor_r0_df),]
johor_r0_df

#create moving averages
johor_r0_df <- johor_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))


#create a 14-day moving incidence rate
johor_r0_df$incident14 <- rollsum(johor_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_johor<- mobility %>% filter (state=="Johor" & date >as.Date("2020-03-19")) 

#create a new varaible for state
johor<- full_join(johor_r0_df, mobility_johor, by=c("date","state"))

#add ab average
johor$average <- (johor$recreation+johor$grocery+johor$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: pahanag
pahang<- state %>% filter(state=="Pahang")

#create control parameters for MCMC
pahang_r0 <- estimate_R(pahang$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(pahang_r0)
pahang_r0_df<- as.data.frame(pahang_r0$R[,c(1:3,5,11)])
pahang_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
pahang_r0_df <- pahang_r0_df[,3:6]
pahang_r0_df$state <- "Pahang"
colnames(pahang_r0_df) <- c("rt","lower","upper","date","state")
pahang_r0_df$case <- pahang$new_cases[8:nrow(pahang)]
pahang_r0_df$total_case <- pahang$total_cases[8:nrow(pahang)]
pahang_r0_df$new_death <- pahang$new_deaths[8:nrow(pahang)]

pahang_r0_df$active_cases_part3[4:nrow(pahang_r0_df)] <- diff(pahang_r0_df$total_case, lag=3)
pahang_r0_df$active_cases3 <- pahang_r0_df$active_cases_part3-pahang_r0_df$new_death
pahang_r0_df$active_cases3[1:3] <- cumsum(pahang_r0_df$case[1:3])-pahang_r0_df$new_death[1:3]
pahang_r0_df$active_cases3[pahang_r0_df$active_cases3<=0] <- 0

pahang_r0_df$active_cases_part5[6:nrow(pahang_r0_df)] <- diff(pahang_r0_df$total_case, lag=5)
pahang_r0_df$active_cases5 <- pahang_r0_df$active_cases_part5-pahang_r0_df$new_death
pahang_r0_df$active_cases5[1:5] <- cumsum(pahang_r0_df$case[1:5])-pahang_r0_df$new_death[1:5]
pahang_r0_df$active_cases5[pahang_r0_df$active_cases5<=0] <- 0

pahang_r0_df$active_cases_part9[10:nrow(pahang_r0_df)] <- diff(pahang_r0_df$total_case, lag=9)
pahang_r0_df$active_cases9 <- pahang_r0_df$active_cases_part9-pahang_r0_df$new_death
pahang_r0_df$active_cases9[1:9] <- cumsum(pahang_r0_df$case[1:9])-pahang_r0_df$new_death[1:9]
pahang_r0_df$active_cases9[pahang_r0_df$active_cases9<=0] <- 0

pahang_r0_df <- pahang_r0_df[1:nrow(pahang_r0_df),]
pahang_r0_df

#create moving averages
pahang_r0_df <- pahang_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
pahang_r0_df$incident14 <- rollsum(pahang_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_pahang<- mobility %>% filter (state=="Pahang" & date >as.Date("2020-03-19")) 

#create a new varaible for state
pahang<- full_join(pahang_r0_df, mobility_pahang, by=c("date","state"))

#add ab average
pahang$average <- (pahang$recreation+pahang$grocery+pahang$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: terengganu
terengganu<- state %>% filter(state=="Terengganu")

#create control parameters for MCMC
terengganu_r0 <- estimate_R(terengganu$new_cases, 
                            method="parametric_si",
                            config = make_config(list(
                              mean_si = 5.12, 
                              std_si = 1.86))#lit review
)

#create df of parameters
plot(terengganu_r0)
terengganu_r0_df<- as.data.frame(terengganu_r0$R[,c(1:3,5,11)])
terengganu_r0_df$date <- seq(from=as.Date("2020-03-20"),to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
terengganu_r0_df <- terengganu_r0_df[,3:6]
terengganu_r0_df$state <- "Terengganu"
colnames(terengganu_r0_df) <- c("rt","lower","upper","date","state")
terengganu_r0_df$case <- terengganu$new_cases[8:nrow(terengganu)]
terengganu_r0_df$total_case <- terengganu$total_cases[8:nrow(terengganu)]
terengganu_r0_df$new_death <- terengganu$new_deaths[8:nrow(terengganu)]

terengganu_r0_df$active_cases_part3[4:nrow(terengganu_r0_df)] <- diff(terengganu_r0_df$total_case, lag=3)
terengganu_r0_df$active_cases3 <- terengganu_r0_df$active_cases_part3-terengganu_r0_df$new_death
terengganu_r0_df$active_cases3[1:3] <- cumsum(terengganu_r0_df$case[1:3])-terengganu_r0_df$new_death[1:3]
terengganu_r0_df$active_cases3[terengganu_r0_df$active_cases3<=0] <- 0

terengganu_r0_df$active_cases_part5[6:nrow(terengganu_r0_df)] <- diff(terengganu_r0_df$total_case, lag=5)
terengganu_r0_df$active_cases5 <- terengganu_r0_df$active_cases_part5-terengganu_r0_df$new_death
terengganu_r0_df$active_cases5[1:5] <- cumsum(terengganu_r0_df$case[1:5])-terengganu_r0_df$new_death[1:5]
terengganu_r0_df$active_cases5[terengganu_r0_df$active_cases5<=0] <- 0

terengganu_r0_df$active_cases_part9[10:nrow(terengganu_r0_df)] <- diff(terengganu_r0_df$total_case, lag=9)
terengganu_r0_df$active_cases9 <- terengganu_r0_df$active_cases_part9-terengganu_r0_df$new_death
terengganu_r0_df$active_cases9[1:9] <- cumsum(terengganu_r0_df$case[1:9])-terengganu_r0_df$new_death[1:9]
terengganu_r0_df$active_cases9[terengganu_r0_df$active_cases9<=0] <- 0

terengganu_r0_df <- terengganu_r0_df[1:nrow(terengganu_r0_df),]
terengganu_r0_df

#create moving averages
terengganu_r0_df <- terengganu_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
terengganu_r0_df$incident14 <- rollsum(terengganu_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_terengganu<- mobility %>% filter (state=="Terengganu" & date >as.Date("2020-03-19")) 

#create a new varaible for state
terengganu<- full_join(terengganu_r0_df, mobility_terengganu, by=c("date","state"))

#add ab average
terengganu$average <- (terengganu$recreation+terengganu$grocery+terengganu$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: kelantan
kelantan<- state %>% filter(state=="Kelantan")

#create control parameters for MCMC
kelantan_r0 <- estimate_R(kelantan$new_cases, 
                          method="parametric_si",
                          config = make_config(list(
                            mean_si = 5.12, 
                            std_si = 1.86))#lit review
)

#create df of parameters
plot(kelantan_r0)
kelantan_r0_df<- as.data.frame(kelantan_r0$R[,c(1:3,5,11)])
kelantan_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
kelantan_r0_df <- kelantan_r0_df[,3:6]
kelantan_r0_df$state <- "Kelantan"
colnames(kelantan_r0_df) <- c("rt","lower","upper","date","state")
kelantan_r0_df$case <- kelantan$new_cases[8:nrow(kelantan)]
kelantan_r0_df$total_case <- kelantan$total_cases[8:nrow(kelantan)]
kelantan_r0_df$new_death <- kelantan$new_deaths[8:nrow(kelantan)]

kelantan_r0_df$active_cases_part3[4:nrow(kelantan_r0_df)] <- diff(kelantan_r0_df$total_case, lag=3)
kelantan_r0_df$active_cases3 <- kelantan_r0_df$active_cases_part3-kelantan_r0_df$new_death
kelantan_r0_df$active_cases3[1:3] <- cumsum(kelantan_r0_df$case[1:3])-kelantan_r0_df$new_death[1:3]
kelantan_r0_df$active_cases3[kelantan_r0_df$active_cases3<=0] <- 0

kelantan_r0_df$active_cases_part5[6:nrow(kelantan_r0_df)] <- diff(kelantan_r0_df$total_case, lag=5)
kelantan_r0_df$active_cases5 <- kelantan_r0_df$active_cases_part5-kelantan_r0_df$new_death
kelantan_r0_df$active_cases5[1:5] <- cumsum(kelantan_r0_df$case[1:5])-kelantan_r0_df$new_death[1:5]
kelantan_r0_df$active_cases5[kelantan_r0_df$active_cases5<=0] <- 0

kelantan_r0_df$active_cases_part9[10:nrow(kelantan_r0_df)] <- diff(kelantan_r0_df$total_case, lag=9)
kelantan_r0_df$active_cases9 <- kelantan_r0_df$active_cases_part9-kelantan_r0_df$new_death
kelantan_r0_df$active_cases9[1:9] <- cumsum(kelantan_r0_df$case[1:9])-kelantan_r0_df$new_death[1:9]
kelantan_r0_df$active_cases9[kelantan_r0_df$active_cases9<=0] <- 0

kelantan_r0_df <- kelantan_r0_df[1:nrow(kelantan_r0_df),]
kelantan_r0_df

#create moving averages
kelantan_r0_df <- kelantan_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
kelantan_r0_df$incident14 <- rollsum(kelantan_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_kelantan<- mobility %>% filter (state=="Kelantan" & date >as.Date("2020-03-19")) 

#create a new varaible for state
kelantan<- full_join(kelantan_r0_df, mobility_kelantan, by=c("date","state"))

#add ab average
kelantan$average <- (kelantan$recreation+kelantan$grocery+kelantan$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: sabah
sabah<- state %>% filter(state=="Sabah")

#create control parameters for MCMC
sabah_r0 <- estimate_R(sabah$new_cases, 
                       method="parametric_si",
                       config = make_config(list(
                         mean_si = 5.12, 
                         std_si = 1.86))#lit review
)

#create df of parameters
plot(sabah_r0)
sabah_r0_df<- as.data.frame(sabah_r0$R[,c(1:3,5,11)])
sabah_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
sabah_r0_df <- sabah_r0_df[,3:6]
sabah_r0_df$state <- "Sabah"
colnames(sabah_r0_df) <- c("rt","lower","upper","date","state")
sabah_r0_df$case <- sabah$new_cases[8:nrow(sabah)]
sabah_r0_df$total_case <- sabah$total_cases[8:nrow(sabah)]
sabah_r0_df$new_death <- sabah$new_deaths[8:nrow(sabah)]

sabah_r0_df$active_cases_part3[4:nrow(sabah_r0_df)] <- diff(sabah_r0_df$total_case, lag=3)
sabah_r0_df$active_cases3 <- sabah_r0_df$active_cases_part3-sabah_r0_df$new_death
sabah_r0_df$active_cases3[1:3] <- cumsum(sabah_r0_df$case[1:3])-sabah_r0_df$new_death[1:3]
sabah_r0_df$active_cases3[sabah_r0_df$active_cases3<=0] <- 0

sabah_r0_df$active_cases_part5[6:nrow(sabah_r0_df)] <- diff(sabah_r0_df$total_case, lag=5)
sabah_r0_df$active_cases5 <- sabah_r0_df$active_cases_part5-sabah_r0_df$new_death
sabah_r0_df$active_cases5[1:5] <- cumsum(sabah_r0_df$case[1:5])-sabah_r0_df$new_death[1:5]
sabah_r0_df$active_cases5[sabah_r0_df$active_cases5<=0] <- 0

sabah_r0_df$active_cases_part9[10:nrow(sabah_r0_df)] <- diff(sabah_r0_df$total_case, lag=9)
sabah_r0_df$active_cases9 <- sabah_r0_df$active_cases_part9-sabah_r0_df$new_death
sabah_r0_df$active_cases9[1:9] <- cumsum(sabah_r0_df$case[1:9])-sabah_r0_df$new_death[1:9]
sabah_r0_df$active_cases9[sabah_r0_df$active_cases9<=0] <- 0

sabah_r0_df <- sabah_r0_df[1:nrow(sabah_r0_df),]
sabah_r0_df


#create moving averages
sabah_r0_df <- sabah_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
sabah_r0_df$incident14 <- rollsum(sabah_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_sabah<- mobility %>% filter (state=="Sabah" & date >as.Date("2020-03-19")) 

#create a new varaible for state
sabah<- full_join(sabah_r0_df, mobility_sabah, by=c("date","state"))

#add ab average
sabah$average <- (sabah$recreation+sabah$grocery+sabah$parks)/3

#################################################################################################################################
#################################################################################################################################
#filter: sarawak
sarawak<- state %>% filter(state=="Sarawak")

#create control parameters for MCMC
sarawak_r0 <- estimate_R(sarawak$new_cases, 
                         method="parametric_si",
                         config = make_config(list(
                           mean_si = 5.12, 
                           std_si = 1.86))#lit review
)

#create df of parameters
plot(sarawak_r0)
sarawak_r0_df<- as.data.frame(sarawak_r0$R[,c(1:3,5,11)])
sarawak_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day)
sarawak_r0_df <- sarawak_r0_df[,3:6]
sarawak_r0_df$state <- "Sarawak"
colnames(sarawak_r0_df) <- c("rt","lower","upper","date","state")
sarawak_r0_df$case <- sarawak$new_cases[8:nrow(sarawak)]
sarawak_r0_df$total_case <- sarawak$total_cases[8:nrow(sarawak)]
sarawak_r0_df$new_death <- sarawak$new_deaths[8:nrow(sarawak)]

sarawak_r0_df$active_cases_part3[4:nrow(sarawak_r0_df)] <- diff(sarawak_r0_df$total_case, lag=3)
sarawak_r0_df$active_cases3 <- sarawak_r0_df$active_cases_part3-sarawak_r0_df$new_death
sarawak_r0_df$active_cases3[1:3] <- cumsum(sarawak_r0_df$case[1:3])-sarawak_r0_df$new_death[1:3]
sarawak_r0_df$active_cases3[sarawak_r0_df$active_cases3<=0] <- 0

sarawak_r0_df$active_cases_part5[6:nrow(sarawak_r0_df)] <- diff(sarawak_r0_df$total_case, lag=5)
sarawak_r0_df$active_cases5 <- sarawak_r0_df$active_cases_part5-sarawak_r0_df$new_death
sarawak_r0_df$active_cases5[1:5] <- cumsum(sarawak_r0_df$case[1:5])-sarawak_r0_df$new_death[1:5]
sarawak_r0_df$active_cases5[sarawak_r0_df$active_cases5<=0] <- 0

sarawak_r0_df$active_cases_part9[10:nrow(sarawak_r0_df)] <- diff(sarawak_r0_df$total_case, lag=9)
sarawak_r0_df$active_cases9 <- sarawak_r0_df$active_cases_part9-sarawak_r0_df$new_death
sarawak_r0_df$active_cases9[1:9] <- cumsum(sarawak_r0_df$case[1:9])-sarawak_r0_df$new_death[1:9]
sarawak_r0_df$active_cases9[sarawak_r0_df$active_cases9<=0] <- 0

sarawak_r0_df <- sarawak_r0_df[1:nrow(sarawak_r0_df),]
sarawak_r0_df

#create moving averages
sarawak_r0_df <- sarawak_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
sarawak_r0_df$incident14 <- rollsum(sarawak_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_sarawak<- mobility %>% filter (state=="Sarawak" & date >as.Date("2020-03-19")) 

#create a new varaible for state
sarawak<- full_join(sarawak_r0_df, mobility_sarawak, by=c("date","state"))

#add ab average
sarawak$average <- (sarawak$recreation+sarawak$grocery+sarawak$parks)/3
#################################################################################################################################
#################################################################################################################################
#filter: labuan
labuan<- state %>% filter(state=="W.P. Labuan")

#create control parameters for MCMC
labuan_r0 <- estimate_R(labuan$new_cases, 
                        method="parametric_si",
                        config = make_config(list(
                          mean_si = 5.12, 
                          std_si = 1.86))#lit review
)

#create df of parameters
plot(labuan_r0)
labuan_r0_df<- as.data.frame(labuan_r0$R[,c(1:3,5,11)])
labuan_r0_df$date <- seq(from=as.Date("2020-03-20"), to=as.Date(Sys.Date()),by=1) # TODO: if elapsed by a day -1 from the date (-1 for each elapsed day) 
labuan_r0_df <- labuan_r0_df[,3:6]
labuan_r0_df$state <- "W.P. Labuan"
colnames(labuan_r0_df) <- c("rt","lower","upper","date","state")
labuan_r0_df$case <- labuan$new_cases[8:nrow(labuan)]
labuan_r0_df$total_case <- labuan$total_cases[8:nrow(labuan)]
labuan_r0_df$new_death <- labuan$new_deaths[8:nrow(labuan)]

labuan_r0_df$active_cases_part3[4:nrow(labuan_r0_df)] <- diff(labuan_r0_df$total_case, lag=3)
labuan_r0_df$active_cases3 <- labuan_r0_df$active_cases_part3-labuan_r0_df$new_death
labuan_r0_df$active_cases3[1:3] <- cumsum(labuan_r0_df$case[1:3])-labuan_r0_df$new_death[1:3]
labuan_r0_df$active_cases3[labuan_r0_df$active_cases3<=0] <- 0

labuan_r0_df$active_cases_part5[6:nrow(labuan_r0_df)] <- diff(labuan_r0_df$total_case, lag=5)
labuan_r0_df$active_cases5 <- labuan_r0_df$active_cases_part5-labuan_r0_df$new_death
labuan_r0_df$active_cases5[1:5] <- cumsum(labuan_r0_df$case[1:5])-labuan_r0_df$new_death[1:5]
labuan_r0_df$active_cases5[labuan_r0_df$active_cases5<=0] <- 0

labuan_r0_df$active_cases_part9[10:nrow(labuan_r0_df)] <- diff(labuan_r0_df$total_case, lag=9)
labuan_r0_df$active_cases9 <- labuan_r0_df$active_cases_part9-labuan_r0_df$new_death
labuan_r0_df$active_cases9[1:9] <- cumsum(labuan_r0_df$case[1:9])-labuan_r0_df$new_death[1:9]
labuan_r0_df$active_cases9[labuan_r0_df$active_cases9<=0] <- 0

labuan_r0_df <- labuan_r0_df[1:nrow(labuan_r0_df),]
labuan_r0_df


#create moving averages
labuan_r0_df <- labuan_r0_df %>%
  mutate(daily_ma01 = rollmean(case, k = 7, fill = "extend"))

#create a 14-day moving incidence rate
labuan_r0_df$incident14 <- rollsum(labuan_r0_df$case,k=14,fill=NA, align="right")

#average mobility of 5 scores for each state`
mobility_labuan<- mobility %>% filter (state=="W.P. Labuan" & date >as.Date("2020-03-19")) 

#create a new varaible for state
labuan<- full_join(labuan_r0_df, mobility_labuan, by=c("date","state"))

#add ab average
labuan$average <- (labuan$recreation+labuan$grocery+labuan$parks)/3

```


```{r, include =FALSE}
#lets then include the state data for health systems and calculate the incidence
#load the state data
state_data_v2 <- read_excel("P:/COVID-19/R0 Malaysia/data/population_healthcapacity/state_data_v3.xlsx", 
    col_types = c("text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric","numeric"))

#calculate the cumulative number of cases
perlis$cumsum <- cumsum(perlis$case)
kedah$cumsum <- cumsum(kedah$case)
penang$cumsum <- cumsum(penang$case)
perak$cumsum <- cumsum(perak$ case)
selangor$cumsum <- cumsum(selangor$case)
kl$cumsum <- cumsum(kl$case)
putrajaya$cumsum <- cumsum(putrajaya$case)
melaka$cumsum <- cumsum(melaka$case)
negeri$cumsum <- cumsum(negeri$case)
johor$cumsum <- cumsum(johor$case)
pahang$cumsum <- cumsum(pahang$case)
terengganu$cumsum <- cumsum(terengganu$case)
kelantan$cumsum <- cumsum(kelantan$case)
sabah$cumsum <- cumsum(sabah$case)
sarawak$cumsum <- cumsum(sarawak$case)
labuan$cumsum <- cumsum(labuan$case)

#lets calculate the incidence by state
perlis$incidence <- round((perlis$cumsum /state_data_v2$population_new[state_data_v2$state=="Perlis"])*100000,2)
kedah$incidence <- round((kedah$cumsum /state_data_v2$population_new[state_data_v2$state=="Kedah"])*100000,2)
penang$incidence <- round((penang$cumsum /state_data_v2$population_new[state_data_v2$state=="Pulau Pinang"])*100000,2)
perak$incidence <- round((perak$cumsum /state_data_v2$population_new[state_data_v2$state=="Perak"])*100000,2)
selangor$incidence <- round((selangor$cumsum /state_data_v2$population_new[state_data_v2$state=="Selangor"])*100000,2)
kl$incidence <- round((kl$cumsum /state_data_v2$population_new[state_data_v2$state=="W.P. Kuala Lumpur"])*100000,2)
putrajaya$incidence <- round((putrajaya$cumsum /state_data_v2$population_new[state_data_v2$state=="W.P. Putrajaya"])*100000,2)
melaka$incidence <- round((melaka$cumsum /state_data_v2$population_new[state_data_v2$state=="Melaka"])*100000,2)
negeri$incidence <- round((negeri$cumsum /state_data_v2$population_new[state_data_v2$state=="Negeri Sembilan"])*100000,2)
johor$incidence <- round((johor$cumsum /state_data_v2$population_new[state_data_v2$state=="Johor"])*100000,2)
pahang$incidence <- round((pahang$cumsum /state_data_v2$population_new[state_data_v2$state=="Pahang"])*100000,2)
terengganu$incidence <- round((terengganu$cumsum /state_data_v2$population_new[state_data_v2$state=="Terengganu"])*100000,2)
kelantan$incidence <- round((kelantan$cumsum /state_data_v2$population_new[state_data_v2$state=="Kelantan"])*100000,2)
sabah$incidence <- round((sabah$cumsum /state_data_v2$population_new[state_data_v2$state=="Sabah"])*100000,2)
sarawak$incidence <- round((sarawak$cumsum /state_data_v2$population_new[state_data_v2$state=="Sarawak"])*100000,2)
labuan$incidence <- round((labuan$cumsum /state_data_v2$population_new[state_data_v2$state=="W.P. Labuan"])*100000,2)

#add 14-day incidence by states
perlis$incidence14_rate <- round((perlis$incident14/state_data_v2$population_new[state_data_v2$state=="Perlis"])*100000,2)
kedah$incidence14_rate <- round((kedah$incident14 /state_data_v2$population_new[state_data_v2$state=="Kedah"])*100000,2)
penang$incidence14_rate <- round((penang$incident14 /state_data_v2$population_new[state_data_v2$state=="Pulau Pinang"])*100000,2)
perak$incidence14_rate <- round((perak$incident14 /state_data_v2$population_new[state_data_v2$state=="Perak"])*100000,2)
selangor$incidence14_rate <- round((selangor$incident14 /state_data_v2$population_new[state_data_v2$state=="Selangor"])*100000,2)
kl$incidence14_rate <- round((kl$incident14 /state_data_v2$population_new[state_data_v2$state=="W.P. Kuala Lumpur"])*100000,2)
putrajaya$incidence14_rate <- round((putrajaya$incident14 /state_data_v2$population_new[state_data_v2$state=="W.P. Putrajaya"])*100000,2)
melaka$incidence14_rate <- round((melaka$incident14 /state_data_v2$population_new[state_data_v2$state=="Melaka"])*100000,2)
negeri$incidence14_rate <- round((negeri$incident14 /state_data_v2$population_new[state_data_v2$state=="Negeri Sembilan"])*100000,2)
johor$incidence14_rate <- round((johor$incident14 /state_data_v2$population_new[state_data_v2$state=="Johor"])*100000,2)
pahang$incidence14_rate <- round((pahang$incident14 /state_data_v2$population_new[state_data_v2$state=="Pahang"])*100000,2)
terengganu$incidence14_rate <- round((terengganu$incident14 /state_data_v2$population_new[state_data_v2$state=="Terengganu"])*100000,2)
kelantan$incidence14_rate <- round((kelantan$incident14 /state_data_v2$population_new[state_data_v2$state=="Kelantan"])*100000,2)
sabah$incidence14_rate <- round((sabah$incident14 /state_data_v2$population_new[state_data_v2$state=="Sabah"])*100000,2)
sarawak$incidence14_rate <- round((sarawak$incident14 /state_data_v2$population_new[state_data_v2$state=="Sarawak"])*100000,2)
labuan$incidence14_rate <- round((labuan$incident14 /state_data_v2$population_new[state_data_v2$state=="W.P. Labuan"])*100000,2)

#add in a column for hospitals and icu beds
perlis$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Perlis"]
kedah$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Kedah"]
penang$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Pulau Pinang"]
perak$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Perak"]
selangor$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Selangor_28122020"]
kl$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="W.P. Kuala Lumpur__28122020"]
putrajaya$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="W.P. Putrajaya"]
melaka$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Melaka"]
negeri$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Negeri Sembilan"]
johor$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Johor"]
pahang$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Pahang"]
kelantan$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Kelantan"]
terengganu$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Terengganu"]
sabah$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Sabah_09012021"]
sarawak$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="Sarawak"]
labuan$hbed <- state_data_v2$total_gov_beds[state_data_v2$state=="W.P. Labuan_29102020"]

#add in a column for percentage of beds left
perlis$bed_perc3 <- (perlis$active_cases3/(perlis$hbed*0.2))*100
kedah$bed_perc3 <- (kedah$active_cases3/(kedah$hbed*0.2))*100
penang$bed_perc3 <- (penang$active_cases3/(penang$hbed*0.2))*100
perak$bed_perc3 <- (perak$active_cases3/(perak$hbed*0.2))*100
selangor$bed_perc3 <- (selangor$active_cases3/(selangor$hbed*0.2))*100
kl$bed_perc3 <- (kl$active_cases3/(kl$hbed*0.2))*100
putrajaya$bed_perc3 <- (putrajaya$active_cases3/(putrajaya$hbed*0.2))*100
melaka$bed_perc3 <- (melaka$active_cases3/(melaka$hbed*0.2))*100
negeri$bed_perc3 <- (negeri$active_cases3/(negeri$hbed*0.2))*100
johor$bed_perc3 <- (johor$active_cases3/(johor$hbed*0.2))*100
pahang$bed_perc3 <- (pahang$active_cases3/(pahang$hbed*0.2))*100
kelantan$bed_perc3 <- (kelantan$active_cases3/(kelantan$hbed*0.2))*100
terengganu$bed_perc3 <- (terengganu$active_cases3/(terengganu$hbed*0.2))*100
sabah$bed_perc3 <- (sabah$active_cases3/sabah$hbed)*100
sarawak$bed_perc3 <- (sarawak$active_cases3/(sarawak$hbed*0.2))*100
labuan$bed_perc3 <- (labuan$active_cases3/labuan$hbed)*100


perlis$bed_perc5 <- (perlis$active_cases5/(perlis$hbed*0.2))*100
kedah$bed_perc5 <- (kedah$active_cases5/(kedah$hbed*0.2))*100
penang$bed_perc5 <- (penang$active_cases5/(penang$hbed*0.2))*100
perak$bed_perc5 <- (perak$active_cases5/(perak$hbed*0.2))*100
selangor$bed_perc5 <- (selangor$active_cases5/(selangor$hbed*0.2))*100
kl$bed_perc5 <- (kl$active_cases5/(kl$hbed*0.2))*100
putrajaya$bed_perc5 <- (putrajaya$active_cases5/(putrajaya$hbed*0.2))*100
melaka$bed_perc5 <- (melaka$active_cases5/(melaka$hbed*0.2))*100
negeri$bed_perc5 <- (negeri$active_cases5/(negeri$hbed*0.2))*100
johor$bed_perc5 <- (johor$active_cases5/(johor$hbed*0.2))*100
pahang$bed_perc5 <- (pahang$active_cases5/(pahang$hbed*0.2))*100
kelantan$bed_perc5 <- (kelantan$active_cases5/(kelantan$hbed*0.2))*100
terengganu$bed_perc5 <- (terengganu$active_cases5/(terengganu$hbed*0.2))*100
sabah$bed_perc5 <- (sabah$active_cases5/sabah$hbed)*100
sarawak$bed_perc5 <- (sarawak$active_cases5/(sarawak$hbed*0.2))*100
labuan$bed_perc5 <- (labuan$active_cases5/labuan$hbed)*100

perlis$bed_perc9 <- (perlis$active_cases9/(perlis$hbed*0.2))*100
kedah$bed_perc9 <- (kedah$active_cases9/(kedah$hbed*0.2))*100
penang$bed_perc9 <- (penang$active_cases9/(penang$hbed*0.2))*100
perak$bed_perc9 <- (perak$active_cases9/(perak$hbed*0.2))*100
selangor$bed_perc9 <- (selangor$active_cases9/(selangor$hbed*0.2))*100
kl$bed_perc9 <- (kl$active_cases9/(kl$hbed*0.2))*100
putrajaya$bed_perc9 <- (putrajaya$active_cases9/(putrajaya$hbed*0.2))*100
melaka$bed_perc9 <- (melaka$active_cases9/(melaka$hbed*0.2))*100
negeri$bed_perc9 <- (negeri$active_cases9/(negeri$hbed*0.2))*100
johor$bed_perc9 <- (johor$active_cases9/(johor$hbed*0.2))*100
pahang$bed_perc9 <- (pahang$active_cases9/(pahang$hbed*0.2))*100
kelantan$bed_perc9 <- (kelantan$active_cases9/(kelantan$hbed*0.2))*100
terengganu$bed_perc9 <- (terengganu$active_cases9/(terengganu$hbed*0.2))*100
sabah$bed_perc9 <- (sabah$active_cases9/sabah$hbed)*100
sarawak$bed_perc9 <- (sarawak$active_cases9/(sarawak$hbed*0.2))*100
labuan$bed_perc9 <- (labuan$active_cases9/labuan$hbed)*100
#add ventilator lines
#sabah_ven <- state_data_v2$ventilator[state_data_v2$state=="Sabah_latest"]

#combine all the states into a single dataset
#row join all the data frames
state_full <- rbind(perlis, kedah, penang, perak,selangor,
                       kl, putrajaya, negeri, melaka, johor,
                       pahang, terengganu, kelantan, sabah, 
                       sarawak, labuan)


mas_state <- full_join(ts_mas, state_full, by=c("state","date","incidence","incidence14_rate","bed_perc5"))

mas_state <- mas_state%>% filter(date>as.Date("2020-03-19"))

```


```{r, include=FALSE}
#data set for incidence curves
#change selected state spelling
state$region[state$state=="Perlis"] <- 'Northern region'
state$region[state$state=="Kedah"] <- 'Northern region'
state$region[state$state=="Pulau Pinang"] <- 'Northern region'
state$region[state$state=="Perak"] <- 'Northern region'
state$region[state$state=="Selangor"] <- 'Central region'
state$region[state$state=="Negeri Sembilan"] <- 'Southern region'
state$region[state$state=="Melaka"] <- 'Southern region'
state$region[state$state=="Johor"] <- 'Southern region'
state$region[state$state=="Pahang"] <- 'Eastern region'
state$region[state$state=="Terengganu"] <- "Eastern region"
state$region[state$state=="Kelantan"] <- 'Eastern region'
state$region[state$state=="Sabah"] <- 'Sabah & W.P. Labuan'
state$region[state$state=="Sarawak"] <- 'Sarawak only'
state$region[state$state=="W.P. Labuan"] <- 'Sabah & W.P. Labuan'
state$region[state$state=="W.P. Kuala Lumpur"] <- "Central region"
state$region[state$state=="W.P. Putrajaya"] <- 'Central region'

#group by regions and sum up new region cases
region <- state %>% select(date,region,new_cases,total_cases) %>% group_by(date,region) %>% summarise(new=sum(new_cases), total=sum(total_cases))
colnames(region) <- c("date","location","new_cases", "total_cases")

#add populations for all states
#state populations
#state populations
johor1 <- 3764300
kedah1	<- 2180600
kelantan1 <- 1885700
melaka1 <- 930700
negeri1 <- 	1245700
pahang1 <-1674600
perak1 <- 2512100
perlis1 <- 254000
penang1 <- 1774600
sabah1	<- 3903400
sarawak1	<- 2812800
selangor1	<- 6528400
terengganu1	<- 1245700
kl1	<- 1780700
labuan1	<- 99300
putrajaya1	<- 103800
central <- selangor1+putrajaya1+kl1
northern <- kedah1+perak1+perlis1+penang1
eastern <- kelantan1+terengganu1+pahang1
southern <- johor1+melaka1+negeri1
sarawak1 <- sarawak1
sabah2 <- sabah1+labuan1

#add a total population column
region$population <- NA
region$population[region$location=="Central region"] <- central
region$population[region$location=="Sarawak only"] <- sarawak1
region$population[region$location=="Sabah & W.P. Labuan"] <- sabah2
region$population[region$location=="Eastern region"] <- eastern
region$population[region$location=="Northern region"] <- northern
region$population[region$location=="Southern region"] <- southern
state$population <- NA
state$population[state$state=="Perlis"] <- perlis1
state$population[state$state=="Kedah"] <- kedah1
state$population[state$state=="Pulau Pinang"] <- penang1
state$population[state$state=="Perak"] <- perak1
state$population[state$state=="Selangor"] <- selangor1
state$population[state$state=="Negeri Sembilan"] <- negeri1
state$population[state$state=="Melaka"] <- melaka1
state$population[state$state=="Johor"] <- johor1
state$population[state$state=="Pahang"] <- pahang1
state$population[state$state=="Terengganu"] <- terengganu1
state$population[state$state=="Kelantan"] <- kelantan1
state$population[state$state=="Sabah"] <- sabah1
state$population[state$state=="Sarawak"] <- sarawak1
state$population[state$state=="W.P. Labuan"] <- labuan1
state$population[state$state=="W.P. Kuala Lumpur"] <- kl1
state$population[state$state=="W.P. Putrajaya"] <- putrajaya1

#calculate the 14-day sum of cases in all countries
region<- region %>% group_by(location) %>% 
  mutate(incident14=roll_sum(new_cases, 14,fill=NA, align="right"))

state <- state %>% group_by(state) %>% 
  mutate(incident14=roll_sum(new_cases, 14,fill=NA, align="right"))

#calculate the 14 day incidence density per 100k for all states
region <- region %>% group_by(date,location) %>% mutate(incident14_rate=round((incident14/population)*100000,2))
region <- region %>% group_by(date,location) %>% mutate(incidence=round((total_cases/population)*100000,2))
state <- state %>% group_by(date,state) %>% mutate(incident14_rate=round((incident14/population)*100000,2))
state <- state %>% group_by(date,state) %>% mutate(incidence=round((total_cases/population)*100000,2))

#select and combine
#join state and region
state_incidence <- as.data.frame(cbind(as.character(state$state), as.numeric(state$incidence), as.numeric(state$incident14_rate)))
state_incidence$date <- as.Date(state$date)
colnames(state_incidence) <- c("state","incidence","incidence14", "date")
state_incidence$incidence2 <- NA
state_incidence$incidence14_2 <- NA
state_incidence$location <-  NA
region_incidence <- as.data.frame(cbind(as.character(region$location), as.numeric(region$incidence), as.numeric(region$incident14_rate)))
region_incidence$date <- as.Date(region$date)
colnames(region_incidence) <- c("location","incidence2","incidence14_2","date")
region_incidence$incidence <- NA
region_incidence$incidence14 <- NA
region_incidence$state <-  NA

#combine state and region
incidence_df <- rbind(region_incidence, state_incidence)

#for some reason (likely the NAs) all numeric columns turn into characters
incidence_df$incidence <- as.numeric(incidence_df$incidence)
incidence_df$incidence2 <- as.numeric(incidence_df$incidence2)
incidence_df$incidence14 <- as.numeric(incidence_df$incidence14)
incidence_df$incidence14_2 <- as.numeric(incidence_df$incidence14_2)

#division variable
incidence_df <- incidence_df%>% mutate(group=ifelse(location %in% NA, "state", "region"))
```


```{r, include=FALSE}
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
death_color<- "#d42e5c"
discharge_color <- "#54b48d"
confirmed_color <- "#d3b629"
```


Epidemic curves {data-orientation=rows}
=====================================  
Row{data-height=150}
-----------------------------------------------------------------------

### Total cases

```{r}
total_cases <- sum(core_set$new_cases)
valueBox(value=total_cases,
         caption="Total cases reported",
         color=confirmed_color,
         icon = "fas fa-user-md")
```

### New cases

```{r}
new_case <- core_set$new_cases[nrow(core_set)]
valueBox(value=new_case,
         caption = "New cases reported",
         color= confirmed_color)
```

### Total deaths

```{r}
total_deaths <- sum(core_set$new_deaths)
valueBox(value=total_deaths,
         caption="Total deaths reported",
         color=death_color,
         icon = "fas fa-ambulance")
```

### New deaths

```{r}
new_deaths <- core_set$new_deaths[nrow(core_set)]
valueBox(value=new_deaths, 
         caption="New deaths reported",
         color=death_color)
```

### Total discharged

```{r}
total_deaths <- sum(core_set$recover)
valueBox(value=total_deaths,
         caption="Total discharged",
         color=discharge_color,
         icon = "fas fa-heartbeat")
```

### New discharges

```{r}
new_deaths <- core_set$recover[nrow(core_set)]
valueBox(value=new_deaths, 
         caption="New discharges reported",
         color=discharge_color)
```


Row {data-height=500 .tabset}
-------------------------------------
### New cases Malaysia
```{r}
#change the background of the legend to transparent
l <- list(
  bgcolor = "transparent",
  bordercolor = "transparent")

#plotly cannot read scale label- change column name
names(ts_mas)[names(ts_mas)=="new"] <- "Daily New Cases"
names(ts_mas)[names(ts_mas)=="daily_ma1"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
mas_epid_curve <- ggplot(data=ts_mas,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="royalblue3")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(ts_mas$`Daily New Cases`)+200) +
  scale_x_date(date_breaks = "2 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(mas_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Malaysia',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

### Active cases Malaysia
```{r}
#plotly cannot read scale label- change column name
names(ts_mas)[names(ts_mas)=="active"] <- "Active Cases"
names(ts_mas)[names(ts_mas)=="daily_ma1"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
mas_epid_curve <- ggplot(data=ts_mas,aes(x=date)) +
  geom_area(aes(y=`Active Cases`),stat="identity",alpha=0.7,col="goldenrod2", fill="goldenrod") + 
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(ts_mas$`Active Cases`)+200) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Active cases")
ggplotly(mas_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Active COVID-19 cases",
                                    '<br>',
                                    '<i>',
                                    'Malaysia',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

Row {.tabset}
-------------------------------------
### Perlis {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(perlis)[names(perlis)=="case"] <- "Daily New Cases"
names(perlis)[names(perlis)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
perlis_epid_curve <- ggplot(data=perlis,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(perlis$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(perlis_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.015,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Perlis',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

### Kedah {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(kedah)[names(kedah)=="case"] <- "Daily New Cases"
names(kedah)[names(kedah)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
kedah_epid_curve <- ggplot(data=kedah,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(kedah$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(kedah_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Kedah',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

### Pulau Pinang {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(penang)[names(penang)=="case"] <- "Daily New Cases"
names(penang)[names(penang)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
penang_epid_curve <- ggplot(data=penang,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(penang$`Daily New Cases`)+50) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(penang_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Penang',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

### Perak {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(perak)[names(perak)=="case"] <- "Daily New Cases"
names(perak)[names(perak)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
perak_epid_curve <- ggplot(data=perak,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(perak$`Daily New Cases`)+50) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(perak_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Perak',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
  
```

### Selangor {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(selangor)[names(selangor)=="case"] <- "Daily New Cases"
names(selangor)[names(selangor)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
selangor_epid_curve <- ggplot(data=selangor,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(selangor$`Daily New Cases`)+250) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(selangor_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Selangor',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### W.P. Kuala Lumpur {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(kl)[names(kl)=="case"] <- "Daily New Cases"
names(kl)[names(kl)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
kl_epid_curve <- ggplot(data=kl,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2"))+
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(kl$`Daily New Cases`)+100) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(kl_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'W.P. Kuala Lumpur',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### W.P. Putrajaya {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(putrajaya)[names(putrajaya)=="case"] <- "Daily New Cases"
names(putrajaya)[names(putrajaya)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
putrajaya_epid_curve <- ggplot(data=putrajaya,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2"))+
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(putrajaya$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(putrajaya_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'W.P. Putrajaya',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Melaka {.no-mobile}
```{r}
#plotly cannot read scale label- change column name
names(melaka)[names(melaka)=="case"] <- "Daily New Cases"
names(melaka)[names(melaka)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
melaka_epid_curve <- ggplot(data=melaka,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(melaka$`Daily New Cases`)+50) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(melaka_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Melaka',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Negeri Sembilan {.no-mobile}
```{r}
names(negeri)[names(negeri)=="case"] <- "Daily New Cases"
names(negeri)[names(negeri)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
negeri_epid_curve <- ggplot(data=negeri,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(negeri$`Daily New Cases`)+150) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(negeri_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Negeri Sembilan',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Johor {.no-mobile}
```{r}
names(johor)[names(johor)=="case"] <- "Daily New Cases"
names(johor)[names(johor)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
johor_epid_curve <- ggplot(data=johor,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(johor$`Daily New Cases`)+200) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(johor_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Johor',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Pahang {.no-mobile}
```{r}
names(pahang)[names(pahang)=="case"] <- "Daily New Cases"
names(pahang)[names(pahang)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
pahang_epid_curve <- ggplot(data=pahang,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2"))+
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(pahang$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(pahang_epid_curve) %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Pahang',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Terengganu {.no-mobile}
```{r}
names(terengganu)[names(terengganu)=="case"] <- "Daily New Cases"
names(terengganu)[names(terengganu)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
terengganu_epid_curve <- ggplot(data=terengganu,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(terengganu$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(terengganu_epid_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Terengganu',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Kelantan {.no-mobile}
```{r}
names(kelantan)[names(kelantan)=="case"] <- "Daily New Cases"
names(kelantan)[names(kelantan)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
kelantan_epid_curve <- ggplot(data=kelantan,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(kelantan$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(kelantan_epid_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Kelantan',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Sarawak {.no-mobile}
```{r}
names(sarawak)[names(sarawak)=="case"] <- "Daily New Cases"
names(sarawak)[names(sarawak)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
sarawak_epid_curve <- ggplot(data=sarawak,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(sarawak$`Daily New Cases`)+25) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(sarawak_epid_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Sarawak',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Sabah {.no-mobile}
```{r}
names(sabah)[names(sabah)=="case"] <- "Daily New Cases"
names(sabah)[names(sabah)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
sabah_epid_curve <- ggplot(data=sabah,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(sabah$`Daily New Cases`)+250) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(sabah_epid_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'Sabah',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### W.P. Labuan {.no-mobile}
```{r}
names(labuan)[names(labuan)=="case"] <- "Daily New Cases"
names(labuan)[names(labuan)=="daily_ma01"] <- "7-day moving average"

##sub plot b - epid curve, ma and rt- modified version
labuan_epid_curve <- ggplot(data=labuan,aes(x=date)) +
  geom_bar(aes(y=`Daily New Cases`,col="Daily New Cases"),stat="identity",alpha=0.7, show.legend = T) + 
  geom_line(aes(y=`7-day moving average`,col="7-day moving average"), size=0.8)+
  scale_colour_manual(name = "",labels = c("7-day moving average"="7-day moving average",
                                 "Daily New Cases"="Daily New Cases"),
                      values = c("Daily New Cases"="transparent", "7-day moving average"="seagreen2")) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0, max(labuan$`Daily New Cases`)+50) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Cases")
ggplotly(labuan_epid_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("Epidemic curve of COVID-19",
                                    '<br>',
                                    '<i>',
                                    'W.P. Labuan',
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

Cumulative Incidence and 14-Day Incidence density {data-orientation=cols} 
=====================================
    
Cols {.tabset}
-------------------------------------
### Cumulative incidence
```{r}
mas_inc_curve <- plot_ly() %>%
  add_lines(data=incidence_df %>% filter(group=="state"), x=~date,y = ~incidence, name=~state, color=~state,
            colors=c("#0000FF", "#63B8FF", "#006400", "#008B45", "#54FF9F", "#C71585", "#EEC900", "#FF8C00", "#68228B", "#FFAEB9", "#CD2626", "#008B8B", "#ADD8E6",
                      "#F08080", "#696969", "#2B2B2B", "#FF1493"))%>%
  add_lines(data=incidence_df %>% filter(group=="region"), x=~date,y = ~incidence2, name=~location, color=~location, 
            colors=c("#CD2626", "#008B45", "#63B8FF", "#2B2B2B", "#FFAEB9", "#EEC900"), visible=FALSE)%>% 
  layout(title = paste0("Cumulative Incidence of COVID-19 cases",
                 '<br>',
                 '<i>',
                 'Malaysia: National and State Level',
                 '</i>'),
  xaxis = list(title = "Date", domain = c(0, 1)),
  yaxis = list(title = paste0("Cumulative Incidence density",
                              '<br>',
                              "(per 100,000 population)")),
  updatemenus = list(
    list(
      y = 0.4, x=1.1,
      buttons = list(
        list(method = "restyle",
             args = list("visible", list(TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,
                                         FALSE,FALSE,FALSE,FALSE,FALSE,FALSE)),
             label = "State"),
        
        list(method = "restyle",
             args = list("visible", list(FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,
                                         TRUE, TRUE, TRUE, TRUE,TRUE, TRUE)),
             label = "Regional"))))) %>% 
  layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(yaxis = list(type = "log", range=c(0.5,3.5),
                      tickvals = as.list(c(10,100,1000)))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE)  %>%
    layout(
        xaxis = list(titlefont = list(size = 12)), 
        yaxis = list(titlefont = list(size = 8))) %>%  
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)))
mas_inc_curve
```


### 14 day incidence density
```{r}
mas_inc_curve <- plot_ly() %>%
  add_lines(data=incidence_df %>% filter(group=="state"), x=~date,y = ~incidence14, name=~state, color=~state,
            colors=c("#0000FF", "#63B8FF", "#006400", "#008B45", "#54FF9F", "#C71585", "#EEC900", "#FF8C00", "#68228B", "#FFAEB9", "#CD2626", "#008B8B", "#ADD8E6",
                      "#F08080", "#696969", "#2B2B2B", "#FF1493"))%>%
  add_lines(data=incidence_df %>% filter(group=="region"), x=~date,y = ~incidence14_2, name=~location, color=~location, 
            colors=c("#CD2626", "#008B45", "#63B8FF", "#2B2B2B", "#FFAEB9", "#EEC900"), visible=FALSE)%>% 
  layout(title = paste0("14-day incidence density of COVID-19 cases",
                 '<br>',
                 '<i>',
                 'Malaysia: National and State Level',
                 '</i>'),
  xaxis = list(title = "Date", domain = c(0, 1)),
  yaxis = list(title = paste0("Incidence density",
                              '<br>',
                              "(per 100,000 population)")),
  updatemenus = list(
    list(
       y = 0.4, x=1.1,
      buttons = list(
        list(method = "restyle",
             args = list("visible", list(TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,TRUE, TRUE, TRUE, TRUE,
                                         FALSE,FALSE,FALSE,FALSE,FALSE,FALSE)),
             label = "State"),
        
        list(method = "restyle",
             args = list("visible", list(FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,FALSE,
                                         TRUE, TRUE, TRUE, TRUE,TRUE, TRUE)),
             label = "Regional"))))) %>% 
  layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= -0.03,
           y= 1.04,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(yaxis = list(type = "log",  
                      tickvals = as.list(c(0.1,1,10,100,1000)))) %>% 
  layout(titlefont=list(size=12)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE)  %>%
    layout(
        xaxis = list(titlefont = list(size = 12)), 
        yaxis = list(titlefont = list(size = 8))) %>%  
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000))) 
mas_inc_curve
```


Health System Capacity {data-orientation=rows} 
=====================================
    
Row {data-height=650}
-------------------------------------
### Malaysia
```{r}
#debugging set
#names(ts_mas)[names(ts_mas)=="General bed utilisation (%)"] <- "bed_perc5"
#names(ts_mas)[names(ts_mas)=="ICU bed utilisation (%)"] <- "icu_perc"
#names(ts_mas)[names(ts_mas)=="Ventilator utilisation (%)"] <- "ven_perc"

#change the name first
names(ts_mas)[names(ts_mas)=="bed_perc5"] <- paste("General bed utilisation (%)","(n=",mas_bed,")")
names(ts_mas)[names(ts_mas)=="icu_perc"] <- paste("ICU bed utilisation (%)","(n=",mas_icu,")")
names(ts_mas)[names(ts_mas)=="ven_perc"] <- paste("Ventilator utilisation (%)","(n=",mas_ven,")")

#plot the incidence curve
mas_cap_curve <- ggplot(data=ts_mas,aes(x=date)) +
  geom_line(aes(y=`General bed utilisation (%) (n= 25456 )`,col="General bed utilisation (%) (n= 25456 )"),
            stat="identity",size=0.6, show.legend = T) + 
  geom_line(aes(y=`ICU bed utilisation (%) (n= 871 )`,col="ICU bed utilisation (%) (n= 871 )"),
            stat="identity",size=0.6,show.legend = T) +
  geom_line(aes(y=`Ventilator utilisation (%) (n= 1581 )`, col="Ventilator utilisation (%) (n= 1581 )"),
            stat="identity",size=0.6,alpha=0.6, show.legend = T) +
  scale_colour_manual(name = "",labels = c("General bed utilisation (%) (n= 25456 )"="General bed utilisation (%)\n 
                                           (n= 25456 )", 
                                           "ICU bed utilisation (%) (n= 871 )"="ICU bed utilisation (%)\n
                                           (n= 871 )", 
                                           "Ventilator utilisation (%) (n= 1581 )"="Ventilator utilisation (%)\n
                                           (n= 1581 )"),
                      values = c("General bed utilisation (%) (n= 25456 )"="#003f5c", 
                                 "ICU bed utilisation (%) (n= 871 )"="#C14953", 
                                 "Ventilator utilisation (%) (n= 1581 )"="#ffa600")) +
  geom_hline(aes(yintercept=100),colour="firebrick2", linetype="dashed",size=0.3, alpha=0.5) +
  theme_minimal() +
  theme(legend.position = c(.95, .5),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.box.background=element_rect(color = "transparent"),
        legend.background=element_rect(color = "transparent"),
        legend.margin = margin(6, 6, 6, 6),
        panel.grid.major.x=element_blank(),
        plot.title = element_text(size=12),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title = element_text(size=10)) +
  ylim(0,300) +
  scale_x_date(date_breaks = "4 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()+1))) +
  labs(x = "Date", y="Utilisation (%)")
ggplotly(mas_cap_curve)%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(title = list(text = paste0("COVID-19 cases and Healthcare capacity",
                                    '<br>',
                                    '<i>',
                                    'Malaysia',
                                    '</i>'))) %>%
  layout(titlefont=list(size=12))  %>% 
 layout(annotations = 
 list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='bottom', xshift=0, yshift=-20,
      font=list(size=7, color="black"))
 ) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```


Row {.tabset}
-------------------------------------
### Perlis {.no-mobile}
```{r}
#change the name first
names(perlis)[names(perlis)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(perlis)[names(perlis)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
perlis <- perlis %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(perlis$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(perlis$bed_perc9)<49.99,"#54b48d","#d3b629"))

perlis_bed_curve <- plot_ly(perlis, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Perlis","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Perlis"]*0.2,0)),")"),
                                    '</i>'))) %>%
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

perlis_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)

```

### Kedah {.no-mobile}
```{r}
#change the name first
names(kedah)[names(kedah)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(kedah)[names(kedah)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
kedah <- kedah %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(kedah$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(kedah$bed_perc9)<49.99,"#54b48d","#d3b629"))

kedah_bed_curve <- plot_ly(kedah, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Kedah","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Kedah"]*0.2,0)),")"),
                                    '</i>'))) %>%
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

kedah_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)

```

### Pulau Pinang {.no-mobile}
```{r}
#change the name first
names(penang)[names(penang)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(penang)[names(penang)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
penang <- penang %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(penang$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(penang$bed_perc9)<49.99,"#54b48d","#d3b629"))

penang_bed_curve <- plot_ly(penang, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Pulau Pinang","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Pulau Pinang"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

penang_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
          x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)

```

### Perak {.no-mobile}
```{r}
#change the name first
names(perak)[names(perak)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(perak)[names(perak)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
perak <- perak %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(perak$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(perak$bed_perc9)<49.99,"#54b48d","#d3b629"))

perak_bed_curve <- plot_ly(perak, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Perak","(n=","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Perak"]*0.2,0)),")"),
                                    '</i>'))) %>%
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

perak_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```


### Selangor {.no-mobile}
```{r}
#change the name first
names(selangor)[names(selangor)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(selangor)[names(selangor)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
selangor <- selangor %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(selangor$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(selangor$bed_perc9)<49.99,"#54b48d","#d3b629"))

selangor_bed_curve <- plot_ly(selangor, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Selangor","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Selangor"],0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

selangor_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
          x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### W.P. Kuala Lumpur {.no-mobile}
```{r}
#change the name first
names(kl)[names(kl)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(kl)[names(kl)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
kl <- kl %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(kl$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(kl$bed_perc9)<49.99,"#54b48d","#d3b629"))

kl_bed_curve <- plot_ly(kl, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>%
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("W.P. Kuala Lumpur","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="W.P. Kuala Lumpur"],0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

kl_bed_curve  %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
   
```

### W.P. Putrajaya {.no-mobile}
```{r}
#change the name first
names(putrajaya)[names(putrajaya)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(putrajaya)[names(putrajaya)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
putrajaya <- putrajaya %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(putrajaya$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(putrajaya$bed_perc9)<49.99,"#54b48d","#d3b629"))

putrajaya_bed_curve <- plot_ly(putrajaya,x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("W.P. Putrajaya","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="W.P. Putrajaya"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

putrajaya_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Negeri Sembilan {.no-mobile}
```{r}
#change the name first
names(negeri)[names(negeri)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(negeri)[names(negeri)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
negeri <- negeri %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(negeri$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(negeri$bed_perc9)<49.99,"#54b48d","#d3b629"))

negeri_bed_curve <- plot_ly(negeri, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Negeri Sembilan","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Negeri Sembilan"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

negeri_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Melaka {.no-mobile}
```{r}
#change the name first
names(melaka)[names(melaka)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(melaka)[names(melaka)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
melaka <- melaka %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(melaka$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(melaka$bed_perc9)<49.99,"#54b48d","#d3b629"))

melaka_bed_curve <- plot_ly(melaka, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Melaka","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Melaka"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))
 
melaka_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Johor {.no-mobile}
```{r}
#change the name first
names(johor)[names(johor)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(johor)[names(johor)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
johor <- johor %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(johor$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(johor$bed_perc9)<49.99,"#54b48d","#d3b629"))

johor_bed_curve <- plot_ly(johor, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Johor","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Johor"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

johor_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Pahang {.no-mobile}
```{r}
#change the name first
names(pahang)[names(pahang)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(pahang)[names(pahang)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
pahang <- pahang %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(pahang$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(pahang$bed_perc9)<49.99,"#54b48d","#d3b629"))

pahang_bed_curve <- plot_ly(pahang, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Pahang","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Pahang"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

pahang_bed_curve%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Terengganu {.no-mobile}
```{r}
#change the name first
names(terengganu)[names(terengganu)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(terengganu)[names(terengganu)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
terengganu <- terengganu %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(terengganu$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(pahang$bed_perc9)<49.99,"#54b48d","#d3b629"))

terengganu_bed_curve <- plot_ly(pahang,x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Terengganu","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Terengganu"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

terengganu_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Kelantan {.no-mobile}
```{r}
#change the name first
names(kelantan)[names(kelantan)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(kelantan)[names(kelantan)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
kelantan <- kelantan %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(kelantan$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(kelantan$bed_perc9)<49.99,"#54b48d","#d3b629"))

kelantan_bed_curve <- plot_ly(kelantan, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Kelantan","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Kelantan"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

kelantan_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Sarawak {.no-mobile}
```{r}
#change the name first
names(sarawak)[names(sarawak)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(sarawak)[names(sarawak)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
sarawak <- sarawak %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(sarawak$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(sarawak$bed_perc5)<49.99,"#54b48d","#d3b629"))

sarawak_bed_curve <- plot_ly(sarawak, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Sarawak","(Estimated COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Sarawak"]*0.2,0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

sarawak_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Sabah {.no-mobile}
```{r}
#change the name first
names(sabah)[names(sabah)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(sabah)[names(sabah)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
sabah <- sabah %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(sabah$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(sabah$bed_perc9)<49.99,"#54b48d","#d3b629"))

sabah_bed_curve <- plot_ly(sabah, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("Sabah","(COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="Sabah"],0)),")"),
                                    '</i>'))) %>%
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))
sabah_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### W.P. Labuan {.no-mobile}
```{r}
#change the name first
names(labuan)[names(labuan)=="bed_perc5"] <- "General bed utilisation Upper Quartile (%)"
names(labuan)[names(labuan)=="bed_perc3"] <- "General bed utilisation Lower Quartile (%)"

#filter outdates
labuan <- labuan %>% filter(date>Sys.Date()-91)

#set colours
cols<- ifelse(max(labuan$bed_perc9)>70.00,"#d42e5c",
                     ifelse(max(labuan$bed_perc9)<49.99,"#54b48d","#d3b629"))

labuan_bed_curve <- plot_ly(labuan, x = ~date, y = ~bed_perc9, type = 'scatter', mode = 'lines',
        line = list(color = cols),
        showlegend = FALSE, name ="Estimated bed occupancy (%)") %>% 
  layout(paper_bgcolor="white", plot_bgcolor="white",
         xaxis = list(title = "Date",
                      gridcolor = 'grey22',
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE),
         yaxis = list(title = "Estimated bed occupancy rate (%)",
                      gridcolor = 'grey22',
                      showgrid = TRUE,
                      showline = FALSE,
                      showticklabels = TRUE,
                      tickcolor = 'rgb(127,127,127)',
                      ticks = 'outside',
                      zeroline = FALSE,
                      range = c(0,250))) %>%
  layout(title = list(text = paste0("Estimated bed-occupancy rate",
                                    '<br>',
                                    '<i>',
                                    paste("W.P. Labuan","(COVID-19 beds, n=",round(max(mas_state$hbed[mas_state$state=="W.P. Labuan"],0)),")"),
                                    '</i>'))) %>% 
  layout(titlefont=list(size=12))  %>% 
  layout(annotations = list(x = 1, y = -0.1, text = "*Data source and methodology utilised in estimation are available in the Documentation section", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=-30,
      font=list(size=7, color="black")))

labuan_bed_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.2,
           sizey = 0.2,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l)
```

### Comparison of estimated bed-occupancy rate {.no-mobile}
```{r, fig.width=18,fig.height=8}
#change ams$state to max 100%
mas_state$bed_perc9[mas_state$state=="Malaysia"] <- mas_state$bed_perc5
mas_state$bed_perc9[mas_state$bed_perc9>=100] <- 100

#change the name first
names(mas_state)[names(mas_state)=="bed_perc9"] <- "General bed utilisation (%)"

#length of colours to set by location
colourCount = length(unique(mas_state$state))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

#order the locations
mas_state$state <- factor(mas_state$state, levels = c("Malaysia", "Sabah","W.P. Labuan","Sarawak","Selangor","W.P. Kuala Lumpur","W.P. Putrajaya",
                                                      "Perak","Pulau Pinang","Kedah","Perlis","Johor","Negeri Sembilan","Melaka",
                                                      "Pahang","Kelantan","Terengganu"))
mas_state$state <- fct_rev(mas_state$state)

#plot the incidence curve
mas_heatmap <- ggplot(data=mas_state) +
  geom_tile(aes(x=date, y=state, fill=`General bed utilisation (%)`),width=6, height=1) +
  scale_fill_viridis(direction=-1,option="B") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title = element_text(size=14, lineheight = 0.5),
        axis.text.y = element_text(size=16),
        axis.text.x = element_text(size=14),
        plot.title = element_text(size=20),
        axis.ticks.x = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        axis.ticks.y = element_line(color = "grey40", 
                                    size = 1, linetype = "solid"),
        legend.box.background=element_blank(),
        legend.background=element_blank(),
        plot.margin = unit(c(0,0,0,0), "cm")) +
  scale_x_date(date_breaks = "2 week", date_minor_breaks = "1 day",
               date_labels = "%e %b", limits =c(as.Date(Sys.Date()-91),as.Date(Sys.Date()))) +
  labs(x = "Date", y="", fill="Bed occupancy (%)") +
  ggtitle("Estimated bed-occupancy rate based on median admission length: 
National and State Level")
mas_heatmap    
```

Transmisibility {data-orientation=rows}
=====================================  
Row {data-height=500}
-------------------------------------
### Malaysia
```{r}
  m <- list(
    l = 20,
    r = 40,
    b = 20,
    t = 20,
    pad = 5
  )


#remove filtered dates
#filter outdates
ts_mas_short <- ts_mas_short %>% filter(date>Sys.Date()-91)


#plotly cannot read scale label- change column name
names(ts_mas_short)[names(ts_mas_short)=="new"] <- "Daily New Cases"

#plot for malaysia
mas_trans_curve <- plot_ly() %>%
  add_bars(data = ts_mas_short, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>%
  add_lines(data = ts_mas_short, x = ~date, y = ~r0, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = ts_mas_short, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = ts_mas_short, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(ts_mas_short$`Daily New Cases`)+200),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.079442/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')), 
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Malaysia",
                                    '</i>')))  
mas_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)

```



Row {.tabset}
-------------------------------------
### Perlis {.no-mobile}
```{r}
#filter outdates
perlis <- perlis %>% filter(date>Sys.Date()-91)

#plotly cannot read scale label- change column name
names(perlis)[names(perlis)=="case"] <- "Daily New Cases"

#plot for malaysia
perlis_trans_curve <- plot_ly() %>%
  add_bars(data = perlis, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = perlis, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = perlis, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = perlis, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(perlis$`Daily New Cases`)+15),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.079442/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Perlis",
                                    '</i>')))

perlis_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
            x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)

```


### Kedah {.no-mobile}
```{r}
#filter outdates
kedah <- kedah %>% filter(date>Sys.Date()-91)

#change the name first
names(kedah)[names(kedah)=="case"] <- "Daily New Cases"

#plot the rt
kedah_trans_curve <- plot_ly() %>%
  add_bars(data = kedah, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = kedah, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = kedah, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = kedah, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kedah$`Daily New Cases`)+75),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.079442/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Kedah",
                                    '</i>')))

kedah_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```


### Pulau Pinang {.no-mobile}
```{r}
#filter outdates
penang <- penang %>% filter(date>Sys.Date()-91)

#change the name first
names(penang)[names(penang)=="case"] <- "Daily New Cases"

#plot the rt
penang_trans_curve <- plot_ly() %>%
  add_bars(data = penang, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = penang, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = penang, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = penang, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(penang$`Daily New Cases`)+50),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Pulau Pinang",
                                    '</i>')))

penang_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE))%>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Perak {.no-mobile}
```{r}
#filter outdates
perak <- perak %>% filter(date>Sys.Date()-91)

#change the name first
names(perak)[names(perak)=="case"] <- "Daily New Cases"

#plot the rt
perak_trans_curve <- plot_ly() %>%
  add_bars(data = perak, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = perak, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = perak, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = perak, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(perak$`Daily New Cases`)+50),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Perak",
                                    '</i>')))

perak_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Selangor {.no-mobile}
```{r}
#filter outdates
selangor <- selangor %>% filter(date>Sys.Date()-91)

#change the name first
names(selangor)[names(selangor)=="case"] <- "Daily New Cases"

#plot the rt
selangor_trans_curve <- plot_ly() %>%
  add_bars(data = selangor, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = selangor, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = selangor, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = selangor, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(selangor$`Daily New Cases`)+200),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Selangor",
                                    '</i>')))

selangor_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Kuala Lumpur {.no-mobile}
```{r}
#filter outdates
kl <- kl %>% filter(date>Sys.Date()-91)

#change the name first
names(kl)[names(kl)=="case"] <- "Daily New Cases"

#plot the rt
kl_trans_curve <- plot_ly() %>%
  add_bars(data = kl, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = kl, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = kl, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = kl, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kl$`Daily New Cases`)+100),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "W.P. Kuala Lumpur",
                                    '</i>')))

kl_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Putrajaya {.no-mobile}
```{r}
#filter outdates
putrajaya <- putrajaya %>% filter(date>Sys.Date()-91)

#change the name first
names(putrajaya)[names(putrajaya)=="case"] <- "Daily New Cases"

#plot the rt
putrajaya_trans_curve <- plot_ly() %>%
  add_bars(data = putrajaya, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = putrajaya, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = putrajaya, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = putrajaya, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(putrajaya$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "W.P. Putrajaya",
                                    '</i>')))

putrajaya_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Melaka {.no-mobile}
```{r}
#filter outdates
melaka <- melaka %>% filter(date>Sys.Date()-91)

#change the name first
names(melaka)[names(melaka)=="case"] <- "Daily New Cases"

#plot the rt
melaka_trans_curve <- plot_ly() %>%
  add_bars(data = melaka, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = melaka, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = melaka, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = melaka, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(melaka$`Daily New Cases`)+40),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Melaka",
                                    '</i>')))

melaka_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Negeri Sembilan {.no-mobile}
```{r}
#filter outdates
negeri <- negeri %>% filter(date>Sys.Date()-91)

#change the name first
names(negeri)[names(negeri)=="case"] <- "Daily New Cases"

#plot the rt
negeri_trans_curve <- plot_ly() %>%
  add_bars(data = negeri, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = negeri, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = negeri, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = negeri, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(negeri$`Daily New Cases`)+150),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Negeri Sembilan",
                                    '</i>')))

negeri_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Johor {.no-mobile}
```{r}
#filter outdates
johor <- johor %>% filter(date>Sys.Date()-91)

#change the name first
names(johor)[names(johor)=="case"] <- "Daily New Cases"

#plot the rt
johor_trans_curve <- plot_ly() %>%
  add_bars(data = johor, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = johor, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = johor, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = johor, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(johor$`Daily New Cases`)+200),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Johor",
                                    '</i>')))

johor_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Pahang {.no-mobile}
```{r}
#filter outdates
pahang <- pahang %>% filter(date>Sys.Date()-91)

#change the name first
names(pahang)[names(pahang)=="case"] <- "Daily New Cases"

#plot the rt
pahang_trans_curve <- plot_ly() %>%
  add_bars(data = pahang, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = pahang, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = pahang, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = pahang, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(pahang$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Pahang",
                                    '</i>')))

pahang_trans_curve%>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Terengganu {.no-mobile}
```{r}
#filter outdates
terengganu <- terengganu %>% filter(date>Sys.Date()-91)

#change the name first
names(terengganu)[names(terengganu)=="case"] <- "Daily New Cases"

#plot the rt
terengganu_trans_curve <- plot_ly() %>%
  add_bars(data = terengganu, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = terengganu, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = terengganu, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = terengganu, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(terengganu$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Terengganu",
                                    '</i>')))

terengganu_trans_curve  %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Kelantan {.no-mobile}
```{r}
#filter outdates
kelantan <- kelantan %>% filter(date>Sys.Date()-91)

#change the name first
names(kelantan)[names(kelantan)=="case"] <- "Daily New Cases"

#plot the rt
kelantan_trans_curve <- plot_ly() %>%
  add_bars(data = kelantan, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = kelantan, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = kelantan, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = kelantan, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kelantan$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Kelantan",
                                    '</i>')))

kelantan_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Sarawak {.no-mobile}
```{r}
#filter outdates
sarawak <- sarawak %>% filter(date>Sys.Date()-91)

#change the name first
names(sarawak)[names(sarawak)=="case"] <- "Daily New Cases"

#plot the rt
sarawak_trans_curve <- plot_ly() %>%
  add_bars(data = sarawak, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = sarawak, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = sarawak, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = sarawak, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(sarawak$`Daily New Cases`)+40),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Sarawak",
                                    '</i>')))

sarawak_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### Sabah {.no-mobile}
```{r}
#filter outdates
sabah <- sabah %>% filter(date>Sys.Date()-91)

#change the name first
names(sabah)[names(sabah)=="case"] <- "Daily New Cases"

#plot the rt
sabah_trans_curve <- plot_ly() %>%
  add_bars(data = sabah, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = sabah, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = sabah, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = sabah, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(sabah$`Daily New Cases`)+250),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "Sabah",
                                    '</i>')))

sabah_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2))))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Labuan {.no-mobile}
```{r}
#filter outdates
labuan <- labuan %>% filter(date>Sys.Date()-91)

#change the name first
names(labuan)[names(labuan)=="case"] <- "Daily New Cases"

#plot the rt
labuan_trans_curve <- plot_ly() %>%
  add_bars(data = labuan, x = ~date, y = ~`Daily New Cases`, name = "New cases", 
           marker=list(color="grey")) %>% 
  add_lines(data = labuan, x = ~date, y = ~rt, name = paste("R",'<sup>',"t",'</sup>'), 
            line=list(width = 4, color = 'rgb(205, 12, 24)'),
            yaxis = 'y2') %>%
  add_lines(data = labuan, x = ~date, y = ~lower, name = paste("95% CI","R",'<sup>',"t",'</sup>'), 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  add_lines(data = labuan, x = ~date, y = ~upper, name = " ", 
            opacity=0.4, line=list(width = 4, dash = 'dot', color = 'rgb(205, 12, 24)'), yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct((Sys.Date()-91), format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(labuan$`Daily New Cases`)+50),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=10), color='grey9', range=c(-1, 2.302585/2),type = "log",
                       title = paste("R",'<sup>',"t",'</sup>')),
         legend = list(x = 1.05, y = 0.9)) %>%
  layout(title = list(text = paste0("Time-varying Reproductive number","(R",'<sup>',"t",'</sup>',")",
                                    '<br>',
                                    '<i>',
                                    "W.P. Labuan",
                                    '</i>')))

labuan_trans_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))  %>%
  layout(xaxis = list(autorange = TRUE)) %>% 
  layout(yaxis2 = list(type = "log",
                      tickvals = as.list(c(seq(0.2,1,0.2), seq(2,10,2)))))%>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 0.95)) %>% 
  layout(legend = l,
         margin=m)
``` 

Movement Restriction and Mobility {data-orientation=rows}
=====================================  

Row {data-height=500}
-------------------------------------
### Malaysia
```{r}
  m <- list(
    l = 20,
    r = 60,
    b = 20,
    t = 20,
    pad = 5
  )

#filter outdates
ts_mas <- ts_mas %>% filter(date>Sys.Date()-91)

#change the name first
names(ts_mas)[names(ts_mas)=="new"] <- "Daily New Cases"

#plot for malaysia
mas_mob_curve <- plot_ly() %>%
  add_bars(data = ts_mas, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = ts_mas, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = ts_mas, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = ts_mas, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(ts_mas$`Daily New Cases`)+250),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)"),
         legend = list(x = 1.05, y = 0.9)))
mas_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Malaysia",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)

```



Row {.tabset}
-------------------------------------
### Perlis {.no-mobile}
```{r}
#change the name first
names(perlis)[names(perlis)=="case"] <- "Daily New Cases"

#plot the rt
#plot for malaysia
perlis_mob_curve <- plot_ly() %>%
  add_bars(data = perlis, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = perlis, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = perlis, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = perlis, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
        xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(perlis$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
perlis_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Perlis",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l, 
         margin=m)

```


### Kedah {.no-mobile}
```{r}
#change the name first
names(kedah)[names(kedah)=="case"] <- "Daily New Cases"

#plot for malaysia
kedah_mob_curve <- plot_ly() %>%
  add_bars(data = kedah, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey"))%>%
  add_lines(data = kedah, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = kedah, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = kedah, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kedah$`Daily New Cases`)+75),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
kedah_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Kedah",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```


### Pulau Pinang {.no-mobile}
```{r}
#change the name first
names(penang)[names(penang)=="case"] <- "Daily New Cases"

#plot for malaysia
penang_mob_curve <- plot_ly() %>%
  add_bars(data = penang, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = penang, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = penang, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = penang, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(penang$`Daily New Cases`)+50),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
penang_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Pulau Pinang",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Perak {.no-mobile}
```{r}
#change the name first
names(perak)[names(perak)=="case"] <- "Daily New Cases"

#plot for malaysia
perak_mob_curve <- plot_ly() %>%
  add_bars(data = perak, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey"))%>%
  add_lines(data = perak, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = perak, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = perak, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(perak$`Daily New Cases`)+50),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
perak_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Perak",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin = m)
```

### Selangor {.no-mobile}
```{r}
#change the name first
names(selangor)[names(selangor)=="case"] <- "Daily New Cases"

#plot for malaysia
selangor_mob_curve <- plot_ly() %>%
  add_bars(data = selangor, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = selangor, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = selangor, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)' ),
            yaxis = 'y2') %>%
    add_lines(data = selangor, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(selangor$`Daily New Cases`)+250),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
selangor_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Selangor",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Kuala Lumpur {.no-mobile}
```{r}
#change the name first
names(kl)[names(kl)=="case"] <- "Daily New Cases"

#plot for malaysia
kl_mob_curve <- plot_ly() %>%
  add_bars(data = kl, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = kl, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = kl, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)' ),
            yaxis = 'y2') %>%
    add_lines(data = kl, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kl$`Daily New Cases`)+100),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
kl_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "W.P. Kuala Lumpur",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Putrajaya {.no-mobile}
```{r}
#change the name first
names(putrajaya)[names(putrajaya)=="case"] <- "Daily New Cases"

#plot for malaysia
putrajaya_mob_curve <- plot_ly() %>%
  add_bars(data = putrajaya, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = putrajaya, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = putrajaya, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = putrajaya, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(putrajaya$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
putrajaya_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "W.P. Putrajaya",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Melaka {.no-mobile}
```{r}
#change the name first
names(melaka)[names(melaka)=="case"] <- "Daily New Cases"

#plot for malaysia
melaka_mob_curve <- plot_ly() %>%
  add_bars(data = melaka, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = melaka, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = melaka, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = melaka, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(melaka$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                      title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
melaka_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Melaka",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Negeri Sembilan {.no-mobile}
```{r}
#change the name first
names(negeri)[names(negeri)=="case"] <- "Daily New Cases"

#plot for malaysia
negeri_mob_curve <- plot_ly() %>%
  add_bars(data = negeri, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = negeri, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = negeri, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = negeri, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(negeri$`Daily New Cases`)+75),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
negeri_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Negeri Sembilan",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Johor {.no-mobile}
```{r}
#change the name first
names(johor)[names(johor)=="case"] <- "Daily New Cases"

#plot for malaysia
johor_mob_curve <- plot_ly() %>%
  add_bars(data = johor, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = johor, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = johor, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = johor, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(johor$`Daily New Cases`)+100),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
johor_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Johor",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Pahang {.no-mobile}
```{r}
#change the name first
names(pahang)[names(pahang)=="case"] <- "Daily New Cases"

#plot for malaysia
pahang_mob_curve <- plot_ly() %>%
  add_bars(data = pahang, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = pahang, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = pahang, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = pahang, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(pahang$`Daily New Cases`)+20),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
pahang_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Pahang",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Terengganu {.no-mobile}
```{r}
#change the name first
names(terengganu)[names(terengganu)=="case"] <- "Daily New Cases"

#plot for malaysia
terengganu_mob_curve <- plot_ly() %>%
  add_bars(data = terengganu, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = terengganu, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = terengganu, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = terengganu, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(terengganu$`Daily New Cases`)+20),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
terengganu_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Terengganu",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Kelantan {.no-mobile}
```{r}
#change the name first
names(kelantan)[names(kelantan)=="case"] <- "Daily New Cases"

#plot for malaysia
kelantan_mob_curve <- plot_ly() %>%
  add_bars(data = kelantan, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = kelantan, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = kelantan, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = kelantan, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(kelantan$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
kelantan_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      ))) %>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Kelantan",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Sarawak {.no-mobile}
```{r}
#change the name first
names(sarawak)[names(sarawak)=="case"] <- "Daily New Cases"

#plot for malaysia
sarawak_mob_curve <- plot_ly() %>%
  add_bars(data = sarawak, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = sarawak, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = sarawak, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = sarawak, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(sarawak$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
sarawak_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))%>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Sarawak",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### Sabah {.no-mobile}
```{r}
#change the name first
names(sabah)[names(sabah)=="case"] <- "Daily New Cases"

#plot for malaysia
sabah_mob_curve <- plot_ly() %>%
  add_bars(data = sabah, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = sabah, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = sabah, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)' ),
            yaxis = 'y2') %>%
    add_lines(data = sabah, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12), 
         xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(sabah$`Daily New Cases`)+250),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
sabah_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))%>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "Sabah",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

### W.P. Labuan {.no-mobile}
```{r}
#change the name first
names(labuan)[names(labuan)=="case"] <- "Daily New Cases"

#plot for malaysia
labuan_mob_curve <- plot_ly() %>%
  add_bars(data = labuan, x = ~date, y = ~`Daily New Cases`, name = "New cases", marker=list(color="grey")) %>%
  add_lines(data = labuan, x = ~date, y = ~average, name = "Grocery, Pharmacy, Recreation,\n Retail and Parks", line=list(width = 4, color = 'rgb(0.4627451,0.7058824,0.7411765)'),
            yaxis = 'y2') %>%
    add_lines(data = labuan, x = ~date, y = ~work, name = "Workplace", line=list(width = 4, color ='rgb(0,6,188)'),
            yaxis = 'y2') %>%
    add_lines(data = labuan, x = ~date, y = ~transit, name = "Transit stations", line=list(width = 4, color = 'rgb(0.3686275,0.3372549,0.3372549)'),
            yaxis = 'y2') %>%
  layout(titlefont=list(size=12),
        xaxis = list(title="Date",
                      range = 
            c(as.numeric(as.POSIXct(Sys.Date()-91, format="%Y-%m-%d"))*1000,
              as.numeric(as.POSIXct(Sys.Date(), format="%Y-%m-%d"))*1000)),
         yaxis = list(tickfont= list(color = 'grey9', size=8), color='grey9', range=c(0,max(labuan$`Daily New Cases`)+30),
                      title="Daily new cases (count)"),
         yaxis2 = list(overlaying = "y", side = "right",
                       tickfont = list(color = 'grey9', size=8), color='grey9', range=c(-100,100),
                       title = paste0("Average change from",
                                    '<br>', "baseline (%)")),
         legend = list(x = 1.05, y = 0.9))
labuan_mob_curve %>% layout(
    images = list(
      list(source = base64enc::dataURI(file = "Picture1.png"),
           xref = "paper",
           yref = "paper",
           x= 0.8,
           y= 1,
           sizex = 0.15,
           sizey = 0.15,
           opacity = 1.1
      )))%>%
  layout(xaxis = list(autorange = TRUE)) %>%
  layout(title = list(text = paste0("Average Google mobility score and COVID-19",
                                    '<br>',
                                    '<i>',
                                    "W.P. Labuan",
                                    '</i>'))) %>%
  config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", "hoverClosestCartesian", "hoverCompareCartesian","lasso2d", "select2d", "pan2d","zoom2d")) %>%
  layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE), yaxis2=list(fixedrange=TRUE)) %>%
  config(displaylogo = FALSE) %>% 
  layout(legend = list(x = 0.05, y = 1.00)) %>% 
  layout(legend = l,
         margin=m)
```

Documentation {data-orientation=rows}
=====================================  

### Documentation
**COVID-19 Epidemiology for Malaysia**

*Department of Social and Preventive Medicine, Faculty of Medicine, University Malaya*

<br />

***Introduction***

The COVID-19 pandemic has propagated the globe over with uneering ease. It has been no different in Malaysia. Despite being able to stem the propagation of two-waves to date, the Malaysian people are now in the midst of a third wave. This dashboard aims to track and leverage on important parameters of disease propagation and control across the country during this third wave of infection as a means of suplementing the decision-making process within the country. As such it present important parameters over the course of the last 90-days only.

<br />

***Documentation***

Data sources, extraction and methods utilised in the development of the dashboard are available in our [documentation page](https://spm.um.edu.my/covid19-epid-live-documentation/)

<br />

***Feedback***

We believe in continuous improvement and would as such love to hear from you on ways we can improve- be it in the usability of the dashboard or the problems with the content. Additionally if you wish to request for our data or source code please do also drop us a line. You can reach out to us using the attached [Feedback form](https://spm.um.edu.my/covid19-epid-live-feedback/) 